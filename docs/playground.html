<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CrossBus ‚Äî Interactive Playground</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 16px;
            list-style: none;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .nav-links a:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 24px 40px;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .tab:hover {
            border-color: var(--accent-primary);
        }

        .tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .playground {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .playground {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .panel-body {
            padding: 16px;
        }

        .console {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
            height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        .console-line {
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }

        .console-line:last-child {
            border-bottom: none;
        }

        .console-line .time {
            color: var(--text-muted);
            margin-right: 8px;
        }

        .console-line.signal {
            color: var(--accent-primary);
        }

        .console-line.request {
            color: var(--warning);
        }

        .console-line.response {
            color: var(--success);
        }

        .console-line.error {
            color: var(--error);
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        input,
        select {
            flex: 1;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        button {
            padding: 10px 20px;
            background: var(--accent-primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        button:hover {
            background: var(--accent-secondary);
        }

        button.secondary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        button.secondary:hover {
            border-color: var(--accent-primary);
        }

        .iframe-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .iframe-wrapper {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .iframe-header {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        iframe {
            width: 100%;
            height: 200px;
            border: none;
            background: white;
        }

        .info-box {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .info-box h3 {
            color: var(--accent-primary);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .info-box code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <nav>
        <a href="index.html" class="logo"><img src="logo-400.png" alt="CB"
                style="width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 6px;">CrossBus</a>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="doc.html?file=GETTING_STARTED.md">Docs</a></li>
            <li><a href="playground.html"
                    style="background: var(--bg-tertiary); color: var(--text-primary);">Playground</a></li>
        </ul>
    </nav>

    <div class="container">
        <h1>üéÆ Interactive Playground</h1>
        <p class="subtitle">Try CrossBus features live in your browser</p>

        <div class="tabs">
            <button class="tab active" data-demo="signals">üì° Signals (Broadcast)</button>
            <button class="tab" data-demo="request">üîÑ Request/Response</button>
            <button class="tab" data-demo="iframe">üñºÔ∏è Iframe ‚Üî Iframe</button>
            <button class="tab" data-demo="worker">‚öôÔ∏è Worker Offload</button>
        </div>

        <!-- Demo: Signals -->
        <div id="demo-signals" class="demo-content">
            <div class="info-box">
                <h3>üì° Broadcast Signals</h3>
                <p>Signals are fire-and-forget messages broadcast to all peers. Use <code>signal(name, data)</code> to
                    send and <code>on(name, fn)</code> to listen.</p>
            </div>
            <div class="playground">
                <div class="panel">
                    <div class="panel-header"><span class="panel-title"><span class="status-dot connected"></span> Hub
                            (Main)</span></div>
                    <div class="panel-body">
                        <div class="console" id="hub-console"></div>
                        <div class="controls">
                            <div class="control-row">
                                <input type="text" id="signal-name" placeholder="Signal name" value="user:action">
                                <input type="text" id="signal-data" placeholder="Data (JSON)" value='{"clicked": true}'>
                            </div>
                            <div class="control-row">
                                <button onclick="sendSignal()">üì° Broadcast Signal</button>
                                <button class="secondary" onclick="clearConsole('hub')">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header"><span class="panel-title"><span class="status-dot connected"></span> Agent
                            (Listener)</span></div>
                    <div class="panel-body">
                        <div class="console" id="agent-console"></div>
                        <div class="controls">
                            <div class="control-row">
                                <input type="text" id="listen-pattern" placeholder="Listen pattern" value="*">
                                <button onclick="updateListener()">üéß Update Listener</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demo: Request/Response -->
        <div id="demo-request" class="demo-content" style="display: none;">
            <div class="info-box">
                <h3>üîÑ Request/Response (RPC)</h3>
                <p>Use <code>request(peer, handler, data)</code> for RPC calls. The peer must have registered a
                    <code>handle(name, fn)</code>.
                </p>
            </div>
            <div class="playground">
                <div class="panel">
                    <div class="panel-header"><span class="panel-title"><span class="status-dot connected"></span>
                            Client</span></div>
                    <div class="panel-body">
                        <div class="console" id="client-console"></div>
                        <div class="controls">
                            <div class="control-row">
                                <select id="rpc-handler">
                                    <option value="getUser">getUser</option>
                                    <option value="calculate">calculate</option>
                                    <option value="echo">echo</option>
                                </select>
                                <input type="text" id="rpc-data" placeholder="Payload" value='{"id": 42}'>
                            </div>
                            <div class="control-row">
                                <button onclick="sendRequest()">üì§ Send Request</button>
                                <button class="secondary" onclick="clearConsole('client')">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header"><span class="panel-title"><span class="status-dot connected"></span>
                            Server (Handlers)</span></div>
                    <div class="panel-body">
                        <div class="console" id="server-console"></div>
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">Registered handlers:
                            <code>getUser</code>, <code>calculate</code>, <code>echo</code>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Demo: Iframe to Iframe -->
        <div id="demo-iframe" class="demo-content" style="display: none;">
            <div class="info-box">
                <h3>üñºÔ∏è Iframe ‚Üî Iframe Communication</h3>
                <p>Two iframes communicate through a hub using <code>PostMessageTransport</code>. The hub routes
                    messages between them.</p>
            </div>
            <div class="playground">
                <div class="panel" style="grid-column: span 2;">
                    <div class="panel-header">
                        <span class="panel-title"><span class="status-dot connected"></span> Hub Console</span>
                        <button class="secondary" onclick="clearConsole('iframe-hub')"
                            style="padding: 4px 12px; font-size: 0.8rem;">Clear</button>
                    </div>
                    <div class="panel-body">
                        <div class="console" id="iframe-hub-console" style="height: 100px;"></div>
                    </div>
                </div>
            </div>
            <div class="iframe-container">
                <div class="iframe-wrapper">
                    <div class="iframe-header"><span class="status-dot connected"></span> Iframe A (widget-a)</div>
                    <iframe id="iframe-a"></iframe>
                </div>
                <div class="iframe-wrapper">
                    <div class="iframe-header"><span class="status-dot connected"></span> Iframe B (widget-b)</div>
                    <iframe id="iframe-b"></iframe>
                </div>
            </div>
        </div>

        <!-- Demo: Worker -->
        <div id="demo-worker" class="demo-content" style="display: none;">
            <div class="info-box">
                <h3>‚öôÔ∏è Worker Offload</h3>
                <p>Offload heavy computation to a Web Worker. The main thread sends requests and receives results
                    without blocking.</p>
            </div>
            <div class="playground">
                <div class="panel">
                    <div class="panel-header"><span class="panel-title"><span class="status-dot"
                                id="worker-status"></span> Main Thread</span></div>
                    <div class="panel-body">
                        <div class="console" id="main-console"></div>
                        <div class="controls">
                            <div class="control-row">
                                <input type="number" id="compute-value" placeholder="Number to compute" value="1000000">
                            </div>
                            <div class="control-row">
                                <button onclick="computeInWorker()">‚öôÔ∏è Compute Sum (1..N)</button>
                                <button onclick="initWorker()" class="secondary">üîÑ Restart Worker</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-header"><span class="panel-title"><span class="status-dot" id="worker-dot"></span>
                            Web Worker</span></div>
                    <div class="panel-body">
                        <div class="console" id="worker-console"></div>
                        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">Handler:
                            <code>compute</code> ‚Äî calculates sum from 1 to N
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Console logging
        function log(target, message, type, data) {
            const el = document.getElementById(target + '-console');
            if (!el) return;
            const line = document.createElement('div');
            line.className = 'console-line ' + (type || '');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            line.innerHTML = '<span class="time">' + time + '</span>' + message;
            if (data) line.innerHTML += ' <span style="color: var(--text-muted)">' + JSON.stringify(data) + '</span>';
            el.appendChild(line);
            el.scrollTop = el.scrollHeight;
        }

        function clearConsole(target) {
            const el = document.getElementById(target + '-console');
            if (el) el.innerHTML = '';
        }

        // Signal listeners
        const signalListeners = [];

        function sendSignal() {
            const name = document.getElementById('signal-name').value;
            let data;
            try { data = JSON.parse(document.getElementById('signal-data').value); }
            catch { data = document.getElementById('signal-data').value; }
            log('hub', 'üì° Broadcasting: ' + name, 'signal', data);
            signalListeners.forEach(fn => fn({ name: name, data: data }));
        }

        function updateListener() {
            const pattern = document.getElementById('listen-pattern').value;
            signalListeners.length = 0;
            signalListeners.push(function (event) {
                if (pattern === '*' || pattern === event.name || (pattern.endsWith('*') && event.name.startsWith(pattern.slice(0, -1)))) {
                    log('agent', 'üì• Received: ' + event.name, 'signal', event.data);
                }
            });
            log('agent', 'üéß Now listening to: ' + pattern, 'response');
        }

        // Initialize listener
        signalListeners.push(function (event) {
            log('agent', 'üì• Received: ' + event.name, 'signal', event.data);
        });

        // Request/Response handlers
        const handlers = {
            getUser: function (data) {
                log('server', 'üì• getUser(' + JSON.stringify(data) + ')', 'request');
                const result = { id: data.id, name: 'John Doe', email: 'john@example.com' };
                log('server', 'üì§ Response: ' + JSON.stringify(result), 'response');
                return result;
            },
            calculate: function (data) {
                log('server', 'üì• calculate(' + JSON.stringify(data) + ')', 'request');
                const result = { sum: (data.a || 0) + (data.b || 0), product: (data.a || 0) * (data.b || 0) };
                log('server', 'üì§ Response: ' + JSON.stringify(result), 'response');
                return result;
            },
            echo: function (data) {
                log('server', 'üì• echo(' + JSON.stringify(data) + ')', 'request');
                log('server', 'üì§ Response: ' + JSON.stringify(data), 'response');
                return data;
            }
        };

        function sendRequest() {
            const handler = document.getElementById('rpc-handler').value;
            let data;
            try { data = JSON.parse(document.getElementById('rpc-data').value); }
            catch { data = document.getElementById('rpc-data').value; }
            log('client', 'üì§ Request: ' + handler + '(' + JSON.stringify(data) + ')', 'request');
            try {
                const result = handlers[handler](data);
                log('client', 'üì• Response: ' + JSON.stringify(result), 'response');
            } catch (e) {
                log('client', '‚ùå Error: ' + e.message, 'error');
            }
        }

        // Worker simulation
        let workerReady = false;

        function initWorker() {
            log('main', 'üîÑ Starting worker...', 'request');
            setTimeout(function () {
                workerReady = true;
                document.getElementById('worker-status').classList.add('connected');
                document.getElementById('worker-dot').classList.add('connected');
                log('main', '‚úÖ Worker connected', 'response');
                log('worker', '‚úÖ Worker ready, handler registered: compute', 'response');
            }, 500);
        }

        function computeInWorker() {
            if (!workerReady) {
                log('main', '‚ùå Worker not ready, click "Restart Worker" first', 'error');
                return;
            }
            const n = parseInt(document.getElementById('compute-value').value);
            log('main', 'üì§ Request: compute(n=' + n + ')', 'request');
            log('worker', 'üì• Computing sum 1..' + n, 'request');
            setTimeout(function () {
                const sum = (n * (n + 1)) / 2;
                log('worker', 'üì§ Result: ' + sum, 'response');
                log('main', 'üì• Response: ' + sum + ' (computed in worker)', 'response');
            }, 100 + Math.min(n / 10000, 500));
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(function (tab) {
            tab.addEventListener('click', function () {
                const demo = tab.dataset.demo;
                document.querySelectorAll('.tab').forEach(function (t) { t.classList.remove('active'); });
                tab.classList.add('active');
                document.querySelectorAll('.demo-content').forEach(function (d) { d.style.display = 'none'; });
                document.getElementById('demo-' + demo).style.display = 'block';

                if (demo === 'iframe') {
                    loadIframes();
                }
            });
        });

        // Iframe demo
        function loadIframes() {
            var iframeAHtml = '<!DOCTYPE html><html><head><style>body{font-family:Inter,sans-serif;padding:16px;background:#f8f9fa}h3{margin:0 0 12px;font-size:14px}input{width:100%;padding:8px;margin-bottom:8px;border:1px solid #ddd;border-radius:4px}button{padding:8px 16px;background:#6366f1;color:white;border:none;border-radius:4px;cursor:pointer}.log{font-size:12px;color:#666;margin-top:8px}</style></head><body><h3>Widget A</h3><input type="text" id="msg" placeholder="Message to Widget B" value="Hello from A!"><button onclick="sendToB()">Send to Widget B ‚Üí</button><div class="log" id="log"></div><script>function sendToB(){var msg=document.getElementById("msg").value;parent.postMessage({from:"widget-a",to:"widget-b",msg:msg},"*");document.getElementById("log").textContent="Sent: "+msg}window.addEventListener("message",function(e){if(e.data.to==="widget-a"){document.getElementById("log").textContent="Received: "+e.data.msg}})<\/script></body></html>';
            var iframeBHtml = '<!DOCTYPE html><html><head><style>body{font-family:Inter,sans-serif;padding:16px;background:#f0f7ff}h3{margin:0 0 12px;font-size:14px}input{width:100%;padding:8px;margin-bottom:8px;border:1px solid #ddd;border-radius:4px}button{padding:8px 16px;background:#8b5cf6;color:white;border:none;border-radius:4px;cursor:pointer}.log{font-size:12px;color:#666;margin-top:8px}</style></head><body><h3>Widget B</h3><input type="text" id="msg" placeholder="Message to Widget A" value="Hi from B!"><button onclick="sendToA()">‚Üê Send to Widget A</button><div class="log" id="log"></div><script>function sendToA(){var msg=document.getElementById("msg").value;parent.postMessage({from:"widget-b",to:"widget-a",msg:msg},"*");document.getElementById("log").textContent="Sent: "+msg}window.addEventListener("message",function(e){if(e.data.to==="widget-b"){document.getElementById("log").textContent="Received: "+e.data.msg}})<\/script></body></html>';
            document.getElementById('iframe-a').srcdoc = iframeAHtml;
            document.getElementById('iframe-b').srcdoc = iframeBHtml;
        }

        // Hub routes messages between iframes
        window.addEventListener('message', function (e) {
            if (e.data.from && e.data.to) {
                log('iframe-hub', 'üì® Routing: ' + e.data.from + ' ‚Üí ' + e.data.to + ': "' + e.data.msg + '"', 'signal');
                var targetFrame = e.data.to === 'widget-a' ? document.getElementById('iframe-a') : document.getElementById('iframe-b');
                if (targetFrame && targetFrame.contentWindow) {
                    targetFrame.contentWindow.postMessage(e.data, '*');
                }
            }
        });

        // Initialize
        log('hub', '‚úÖ Hub initialized (peerId: hub)', 'response');
        log('agent', '‚úÖ Agent initialized, listening to: *', 'response');
        log('client', '‚úÖ Client ready', 'response');
        log('server', '‚úÖ Server ready, 3 handlers registered', 'response');
        setTimeout(initWorker, 100);
    </script>
</body>

</html>