{"version":3,"file":"testing.min.js","sources":["../src/testing/mock-transport.js"],"sourcesContent":["/**\n * @fileoverview Mock transport for testing CrossBus without browser APIs.\n * @module testing/mock-transport\n */\n\n/**\n * @typedef {Object} CapturedMessage\n * @property {Object} message - The message sent\n * @property {number} timestamp - When it was sent\n */\n\n/**\n * Mock transport for unit testing CrossBus.\n * Simulates a peer without requiring browser APIs.\n * \n * @example\n * const mock = new MockTransport('widget-1');\n * \n * // Connect to CrossBus\n * bus.addPeer('widget-1', mock.send);\n * \n * // Simulate incoming message\n * mock.simulateMessage({ type: 'ready', payload: {} });\n * \n * // Check what was sent\n * expect(mock.getLastSent()).toEqual({ ... });\n */\nexport class MockTransport {\n    /** @type {string} */\n    #peerId;\n\n    /** @type {CapturedMessage[]} */\n    #sentMessages = [];\n\n    /** @type {CapturedMessage[]} */\n    #receivedMessages = [];\n\n    /** @type {((message: Object) => void)|null} */\n    #messageHandler = null;\n\n    /** @type {number} */\n    #latencyMs = 0;\n\n    /** @type {boolean} */\n    #shouldFail = false;\n\n    /** @type {string|null} */\n    #failureMessage = null;\n\n    /** @type {boolean} */\n    #connected = true;\n\n    /**\n     * Creates a new mock transport.\n     * @param {string} peerId - Peer ID to simulate\n     * @param {Object} [options={}] - Options\n     * @param {number} [options.latencyMs=0] - Simulated latency in ms\n     */\n    constructor(peerId, options = {}) {\n        this.#peerId = peerId;\n        this.#latencyMs = options.latencyMs ?? 0;\n    }\n\n    /**\n     * Gets the peer ID.\n     * @returns {string}\n     */\n    get peerId() {\n        return this.#peerId;\n    }\n\n    /**\n     * Gets whether the mock is connected.\n     * @returns {boolean}\n     */\n    get connected() {\n        return this.#connected;\n    }\n\n    /**\n     * The send function to pass to CrossBus.addPeer().\n     * @returns {(message: Object) => void}\n     */\n    get send() {\n        /** @type {(message: Object) => void} */\n        const sendFn = (message) => {\n            if (this.#shouldFail) {\n                throw new Error(this.#failureMessage ?? 'Mock send failure');\n            }\n\n            if (!this.#connected) {\n                throw new Error('Mock transport disconnected');\n            }\n\n            this.#sentMessages.push({\n                message,\n                timestamp: Date.now()\n            });\n        };\n        return sendFn;\n    }\n\n    /**\n     * Sets the message handler (called for simulated incoming messages).\n     * @param {(message: Object) => void} handler\n     */\n    onMessage(handler) {\n        this.#messageHandler = handler;\n    }\n\n    /**\n     * Simulates receiving a message from the peer.\n     * @param {Object} message - Message to simulate\n     * @param {Object} [options={}] - Options\n     * @param {number} [options.delay] - Override latency for this message\n     */\n    async simulateMessage(message, options = {}) {\n        const delay = options.delay ?? this.#latencyMs;\n\n        this.#receivedMessages.push({\n            message,\n            timestamp: Date.now()\n        });\n\n        if (delay > 0) {\n            await new Promise(r => setTimeout(r, delay));\n        }\n\n        if (this.#messageHandler) {\n            this.#messageHandler(message);\n        }\n    }\n\n    /**\n     * Simulates a disconnect.\n     */\n    disconnect() {\n        this.#connected = false;\n    }\n\n    /**\n     * Simulates a reconnect.\n     */\n    reconnect() {\n        this.#connected = true;\n    }\n\n    /**\n     * Configures the mock to fail on next send.\n     * @param {string} [message] - Error message\n     */\n    failOnNextSend(message) {\n        this.#shouldFail = true;\n        this.#failureMessage = message ?? null;\n    }\n\n    /**\n     * Resets failure mode.\n     */\n    resetFailure() {\n        this.#shouldFail = false;\n        this.#failureMessage = null;\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Inspection methods\n    // ─────────────────────────────────────────────────────────────────\n\n    /**\n     * Gets all sent messages.\n     * @returns {CapturedMessage[]}\n     */\n    getSentMessages() {\n        return [...this.#sentMessages];\n    }\n\n    /**\n     * Gets the last sent message.\n     * @returns {Object|undefined}\n     */\n    getLastSent() {\n        return this.#sentMessages[this.#sentMessages.length - 1]?.message;\n    }\n\n    /**\n     * Gets sent message count.\n     * @returns {number}\n     */\n    get sentCount() {\n        return this.#sentMessages.length;\n    }\n\n    /**\n     * Gets all received (simulated) messages.\n     * @returns {CapturedMessage[]}\n     */\n    getReceivedMessages() {\n        return [...this.#receivedMessages];\n    }\n\n    /**\n     * Checks if a message with specific properties was sent.\n     * @param {Object} matcher - Properties to match\n     * @returns {boolean}\n     */\n    wasSent(matcher) {\n        return this.#sentMessages.some(({ message }) =>\n            Object.entries(matcher).every(([key, value]) =>\n                JSON.stringify(message[key]) === JSON.stringify(value)\n            )\n        );\n    }\n\n    /**\n     * Waits for a specific number of messages to be sent.\n     * @param {number} count - Expected count\n     * @param {number} [timeoutMs=1000] - Timeout\n     * @returns {Promise<CapturedMessage[]>}\n     */\n    async waitForMessages(count, timeoutMs = 1000) {\n        const start = Date.now();\n        while (this.#sentMessages.length < count) {\n            if (Date.now() - start > timeoutMs) {\n                throw new Error(`Timeout waiting for ${count} messages, got ${this.#sentMessages.length}`);\n            }\n            await new Promise(r => setTimeout(r, 10));\n        }\n        return this.getSentMessages();\n    }\n\n    /**\n     * Clears all captured messages.\n     */\n    clear() {\n        this.#sentMessages = [];\n        this.#receivedMessages = [];\n    }\n\n    /**\n     * Resets the mock to initial state.\n     */\n    reset() {\n        this.clear();\n        this.resetFailure();\n        this.reconnect();\n    }\n}\n\n/**\n * Creates a pair of connected mock transports for testing.\n * Messages sent to one are received by the other.\n * \n * @param {string} peerId1 - First peer ID\n * @param {string} peerId2 - Second peer ID\n * @returns {{ transport1: MockTransport, transport2: MockTransport }}\n * \n * @example\n * const { transport1, transport2 } = createConnectedMocks('hub', 'widget');\n * // Messages sent via transport1 are received by transport2\n */\nexport function createConnectedMocks(peerId1, peerId2) {\n    const transport1 = new MockTransport(peerId1);\n    const transport2 = new MockTransport(peerId2);\n\n    // Wire them together\n    const originalSend1 = transport1.send;\n    const originalSend2 = transport2.send;\n\n    // Override sends to forward to the other transport\n    Object.defineProperty(transport1, 'send', {\n        get() {\n            return (message) => {\n                originalSend1(message);\n                transport2.simulateMessage(message);\n            };\n        }\n    });\n\n    Object.defineProperty(transport2, 'send', {\n        get() {\n            return (message) => {\n                originalSend2(message);\n                transport1.simulateMessage(message);\n            };\n        }\n    });\n\n    return { transport1, transport2 };\n}\n"],"names":["createConnectedMocks","peerId1","peerId2","transport1","MockTransport","transport2","originalSend1","send","originalSend2","Object","defineProperty","get","message","simulateMessage","peerId","sentMessages","receivedMessages","messageHandler","latencyMs","shouldFail","failureMessage","connected","constructor","options","this","Error","push","timestamp","Date","now","onMessage","handler","delay","Promise","r","setTimeout","disconnect","reconnect","failOnNextSend","resetFailure","getSentMessages","getLastSent","length","sentCount","getReceivedMessages","wasSent","matcher","some","entries","every","key","value","JSON","stringify","waitForMessages","count","timeoutMs","start","clear","reset"],"mappings":"AAoQO,SAASA,EAAqBC,EAASC,GAC1C,MAAMC,EAAa,IAAIC,EAAcH,GAC/BI,EAAa,IAAID,EAAcF,GAG/BI,EAAgBH,EAAWI,KAC3BC,EAAgBH,EAAWE,KAqBjC,OAlBAE,OAAOC,eAAeP,EAAY,OAAQ,CACtCQ,IAAG,IACSC,IACJN,EAAcM,GACdP,EAAWQ,gBAAgBD,MAKvCH,OAAOC,eAAeL,EAAY,OAAQ,CACtCM,IAAG,IACSC,IACJJ,EAAcI,GACdT,EAAWU,gBAAgBD,MAKhC,CAAET,aAAYE,aACzB,CArQO,MAAMD,EAETU,GAGAC,GAAgB,GAGhBC,GAAoB,GAGpBC,GAAkB,KAGlBC,GAAa,EAGbC,IAAc,EAGdC,GAAkB,KAGlBC,IAAa,EAQb,WAAAC,CAAYR,EAAQS,EAAU,IAC1BC,MAAKV,EAAUA,EACfU,MAAKN,EAAaK,EAAQL,WAAa,CAC3C,CAMA,UAAIJ,GACA,OAAOU,MAAKV,CAChB,CAMA,aAAIO,GACA,OAAOG,MAAKH,CAChB,CAMA,QAAId,GAgBA,OAdgBK,IACZ,GAAIY,MAAKL,EACL,MAAM,IAAIM,MAAMD,MAAKJ,GAAmB,qBAG5C,IAAKI,MAAKH,EACN,MAAM,IAAII,MAAM,+BAGpBD,MAAKT,EAAcW,KAAK,CACpBd,UACAe,UAAWC,KAAKC,QAI5B,CAMA,SAAAC,CAAUC,GACNP,MAAKP,EAAkBc,CAC3B,CAQA,qBAAMlB,CAAgBD,EAASW,EAAU,IACrC,MAAMS,EAAQT,EAAQS,OAASR,MAAKN,EAEpCM,MAAKR,EAAkBU,KAAK,CACxBd,UACAe,UAAWC,KAAKC,QAGhBG,EAAQ,SACF,IAAIC,QAAQC,GAAKC,WAAWD,EAAGF,IAGrCR,MAAKP,GACLO,MAAKP,EAAgBL,EAE7B,CAKA,UAAAwB,GACIZ,MAAKH,GAAa,CACtB,CAKA,SAAAgB,GACIb,MAAKH,GAAa,CACtB,CAMA,cAAAiB,CAAe1B,GACXY,MAAKL,GAAc,EACnBK,MAAKJ,EAAkBR,GAAW,IACtC,CAKA,YAAA2B,GACIf,MAAKL,GAAc,EACnBK,MAAKJ,EAAkB,IAC3B,CAUA,eAAAoB,GACI,MAAO,IAAIhB,MAAKT,EACpB,CAMA,WAAA0B,GACI,OAAOjB,MAAKT,EAAcS,MAAKT,EAAc2B,OAAS,IAAI9B,OAC9D,CAMA,aAAI+B,GACA,OAAOnB,MAAKT,EAAc2B,MAC9B,CAMA,mBAAAE,GACI,MAAO,IAAIpB,MAAKR,EACpB,CAOA,OAAA6B,CAAQC,GACJ,OAAOtB,MAAKT,EAAcgC,KAAK,EAAGnC,aAC9BH,OAAOuC,QAAQF,GAASG,MAAM,EAAEC,EAAKC,KACjCC,KAAKC,UAAUzC,EAAQsC,MAAUE,KAAKC,UAAUF,IAG5D,CAQA,qBAAMG,CAAgBC,EAAOC,EAAY,KACrC,MAAMC,EAAQ7B,KAAKC,MACnB,KAAOL,MAAKT,EAAc2B,OAASa,GAAO,CACtC,GAAI3B,KAAKC,MAAQ4B,EAAQD,EACrB,MAAM,IAAI/B,MAAM,uBAAuB8B,mBAAuB/B,MAAKT,EAAc2B,gBAE/E,IAAIT,QAAQC,GAAKC,WAAWD,EAAG,IACzC,CACA,OAAOV,KAAKgB,iBAChB,CAKA,KAAAkB,GACIlC,MAAKT,EAAgB,GACrBS,MAAKR,EAAoB,EAC7B,CAKA,KAAA2C,GACInC,KAAKkC,QACLlC,KAAKe,eACLf,KAAKa,WACT"}