{"version":3,"file":"testing.js","sources":["../src/testing/mock-transport.js"],"sourcesContent":["/**\n * @fileoverview Mock transport for testing CrossBus without browser APIs.\n * @module testing/mock-transport\n */\n\n/**\n * @typedef {Object} CapturedMessage\n * @property {Object} message - The message sent\n * @property {number} timestamp - When it was sent\n */\n\n/**\n * Mock transport for unit testing CrossBus.\n * Simulates a peer without requiring browser APIs.\n * \n * @example\n * const mock = new MockTransport('widget-1');\n * \n * // Connect to CrossBus\n * bus.addPeer('widget-1', mock.send);\n * \n * // Simulate incoming message\n * mock.simulateMessage({ type: 'ready', payload: {} });\n * \n * // Check what was sent\n * expect(mock.getLastSent()).toEqual({ ... });\n */\nexport class MockTransport {\n    /** @type {string} */\n    #peerId;\n\n    /** @type {CapturedMessage[]} */\n    #sentMessages = [];\n\n    /** @type {CapturedMessage[]} */\n    #receivedMessages = [];\n\n    /** @type {((message: Object) => void)|null} */\n    #messageHandler = null;\n\n    /** @type {number} */\n    #latencyMs = 0;\n\n    /** @type {boolean} */\n    #shouldFail = false;\n\n    /** @type {string|null} */\n    #failureMessage = null;\n\n    /** @type {boolean} */\n    #connected = true;\n\n    /**\n     * Creates a new mock transport.\n     * @param {string} peerId - Peer ID to simulate\n     * @param {Object} [options={}] - Options\n     * @param {number} [options.latencyMs=0] - Simulated latency in ms\n     */\n    constructor(peerId, options = {}) {\n        this.#peerId = peerId;\n        this.#latencyMs = options.latencyMs ?? 0;\n    }\n\n    /**\n     * Gets the peer ID.\n     * @returns {string}\n     */\n    get peerId() {\n        return this.#peerId;\n    }\n\n    /**\n     * Gets whether the mock is connected.\n     * @returns {boolean}\n     */\n    get connected() {\n        return this.#connected;\n    }\n\n    /**\n     * The send function to pass to CrossBus.addPeer().\n     * @returns {(message: Object) => void}\n     */\n    get send() {\n        /** @type {(message: Object) => void} */\n        const sendFn = (message) => {\n            if (this.#shouldFail) {\n                throw new Error(this.#failureMessage ?? 'Mock send failure');\n            }\n\n            if (!this.#connected) {\n                throw new Error('Mock transport disconnected');\n            }\n\n            this.#sentMessages.push({\n                message,\n                timestamp: Date.now()\n            });\n        };\n        return sendFn;\n    }\n\n    /**\n     * Sets the message handler (called for simulated incoming messages).\n     * @param {(message: Object) => void} handler\n     */\n    onMessage(handler) {\n        this.#messageHandler = handler;\n    }\n\n    /**\n     * Simulates receiving a message from the peer.\n     * @param {Object} message - Message to simulate\n     * @param {Object} [options={}] - Options\n     * @param {number} [options.delay] - Override latency for this message\n     */\n    async simulateMessage(message, options = {}) {\n        const delay = options.delay ?? this.#latencyMs;\n\n        this.#receivedMessages.push({\n            message,\n            timestamp: Date.now()\n        });\n\n        if (delay > 0) {\n            await new Promise(r => setTimeout(r, delay));\n        }\n\n        if (this.#messageHandler) {\n            this.#messageHandler(message);\n        }\n    }\n\n    /**\n     * Simulates a disconnect.\n     */\n    disconnect() {\n        this.#connected = false;\n    }\n\n    /**\n     * Simulates a reconnect.\n     */\n    reconnect() {\n        this.#connected = true;\n    }\n\n    /**\n     * Configures the mock to fail on next send.\n     * @param {string} [message] - Error message\n     */\n    failOnNextSend(message) {\n        this.#shouldFail = true;\n        this.#failureMessage = message ?? null;\n    }\n\n    /**\n     * Resets failure mode.\n     */\n    resetFailure() {\n        this.#shouldFail = false;\n        this.#failureMessage = null;\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Inspection methods\n    // ─────────────────────────────────────────────────────────────────\n\n    /**\n     * Gets all sent messages.\n     * @returns {CapturedMessage[]}\n     */\n    getSentMessages() {\n        return [...this.#sentMessages];\n    }\n\n    /**\n     * Gets the last sent message.\n     * @returns {Object|undefined}\n     */\n    getLastSent() {\n        return this.#sentMessages[this.#sentMessages.length - 1]?.message;\n    }\n\n    /**\n     * Gets sent message count.\n     * @returns {number}\n     */\n    get sentCount() {\n        return this.#sentMessages.length;\n    }\n\n    /**\n     * Gets all received (simulated) messages.\n     * @returns {CapturedMessage[]}\n     */\n    getReceivedMessages() {\n        return [...this.#receivedMessages];\n    }\n\n    /**\n     * Checks if a message with specific properties was sent.\n     * @param {Object} matcher - Properties to match\n     * @returns {boolean}\n     */\n    wasSent(matcher) {\n        return this.#sentMessages.some(({ message }) =>\n            Object.entries(matcher).every(([key, value]) =>\n                JSON.stringify(message[key]) === JSON.stringify(value)\n            )\n        );\n    }\n\n    /**\n     * Waits for a specific number of messages to be sent.\n     * @param {number} count - Expected count\n     * @param {number} [timeoutMs=1000] - Timeout\n     * @returns {Promise<CapturedMessage[]>}\n     */\n    async waitForMessages(count, timeoutMs = 1000) {\n        const start = Date.now();\n        while (this.#sentMessages.length < count) {\n            if (Date.now() - start > timeoutMs) {\n                throw new Error(`Timeout waiting for ${count} messages, got ${this.#sentMessages.length}`);\n            }\n            await new Promise(r => setTimeout(r, 10));\n        }\n        return this.getSentMessages();\n    }\n\n    /**\n     * Clears all captured messages.\n     */\n    clear() {\n        this.#sentMessages = [];\n        this.#receivedMessages = [];\n    }\n\n    /**\n     * Resets the mock to initial state.\n     */\n    reset() {\n        this.clear();\n        this.resetFailure();\n        this.reconnect();\n    }\n}\n\n/**\n * Creates a pair of connected mock transports for testing.\n * Messages sent to one are received by the other.\n * \n * @param {string} peerId1 - First peer ID\n * @param {string} peerId2 - Second peer ID\n * @returns {{ transport1: MockTransport, transport2: MockTransport }}\n * \n * @example\n * const { transport1, transport2 } = createConnectedMocks('hub', 'widget');\n * // Messages sent via transport1 are received by transport2\n */\nexport function createConnectedMocks(peerId1, peerId2) {\n    const transport1 = new MockTransport(peerId1);\n    const transport2 = new MockTransport(peerId2);\n\n    // Wire them together\n    const originalSend1 = transport1.send;\n    const originalSend2 = transport2.send;\n\n    // Override sends to forward to the other transport\n    Object.defineProperty(transport1, 'send', {\n        get() {\n            return (message) => {\n                originalSend1(message);\n                transport2.simulateMessage(message);\n            };\n        }\n    });\n\n    Object.defineProperty(transport2, 'send', {\n        get() {\n            return (message) => {\n                originalSend2(message);\n                transport1.simulateMessage(message);\n            };\n        }\n    });\n\n    return { transport1, transport2 };\n}\n"],"names":[],"mappings":";AAAA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAM,aAAa,CAAC;AAC3B;AACA,IAAI,OAAO;;AAEX;AACA,IAAI,aAAa,GAAG,EAAE;;AAEtB;AACA,IAAI,iBAAiB,GAAG,EAAE;;AAE1B;AACA,IAAI,eAAe,GAAG,IAAI;;AAE1B;AACA,IAAI,UAAU,GAAG,CAAC;;AAElB;AACA,IAAI,WAAW,GAAG,KAAK;;AAEvB;AACA,IAAI,eAAe,GAAG,IAAI;;AAE1B;AACA,IAAI,UAAU,GAAG,IAAI;;AAErB;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,WAAW,CAAC,MAAM,EAAE,OAAO,GAAG,EAAE,EAAE;AACtC,QAAQ,IAAI,CAAC,OAAO,GAAG,MAAM;AAC7B,QAAQ,IAAI,CAAC,UAAU,GAAG,OAAO,CAAC,SAAS,IAAI,CAAC;AAChD,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,IAAI,MAAM,GAAG;AACjB,QAAQ,OAAO,IAAI,CAAC,OAAO;AAC3B,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,IAAI,SAAS,GAAG;AACpB,QAAQ,OAAO,IAAI,CAAC,UAAU;AAC9B,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,IAAI,IAAI,GAAG;AACf;AACA,QAAQ,MAAM,MAAM,GAAG,CAAC,OAAO,KAAK;AACpC,YAAY,IAAI,IAAI,CAAC,WAAW,EAAE;AAClC,gBAAgB,MAAM,IAAI,KAAK,CAAC,IAAI,CAAC,eAAe,IAAI,mBAAmB,CAAC;AAC5E,YAAY;;AAEZ,YAAY,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE;AAClC,gBAAgB,MAAM,IAAI,KAAK,CAAC,6BAA6B,CAAC;AAC9D,YAAY;;AAEZ,YAAY,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC;AACpC,gBAAgB,OAAO;AACvB,gBAAgB,SAAS,EAAE,IAAI,CAAC,GAAG;AACnC,aAAa,CAAC;AACd,QAAQ,CAAC;AACT,QAAQ,OAAO,MAAM;AACrB,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,SAAS,CAAC,OAAO,EAAE;AACvB,QAAQ,IAAI,CAAC,eAAe,GAAG,OAAO;AACtC,IAAI;;AAEJ;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,MAAM,eAAe,CAAC,OAAO,EAAE,OAAO,GAAG,EAAE,EAAE;AACjD,QAAQ,MAAM,KAAK,GAAG,OAAO,CAAC,KAAK,IAAI,IAAI,CAAC,UAAU;;AAEtD,QAAQ,IAAI,CAAC,iBAAiB,CAAC,IAAI,CAAC;AACpC,YAAY,OAAO;AACnB,YAAY,SAAS,EAAE,IAAI,CAAC,GAAG;AAC/B,SAAS,CAAC;;AAEV,QAAQ,IAAI,KAAK,GAAG,CAAC,EAAE;AACvB,YAAY,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,UAAU,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;AACxD,QAAQ;;AAER,QAAQ,IAAI,IAAI,CAAC,eAAe,EAAE;AAClC,YAAY,IAAI,CAAC,eAAe,CAAC,OAAO,CAAC;AACzC,QAAQ;AACR,IAAI;;AAEJ;AACA;AACA;AACA,IAAI,UAAU,GAAG;AACjB,QAAQ,IAAI,CAAC,UAAU,GAAG,KAAK;AAC/B,IAAI;;AAEJ;AACA;AACA;AACA,IAAI,SAAS,GAAG;AAChB,QAAQ,IAAI,CAAC,UAAU,GAAG,IAAI;AAC9B,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,cAAc,CAAC,OAAO,EAAE;AAC5B,QAAQ,IAAI,CAAC,WAAW,GAAG,IAAI;AAC/B,QAAQ,IAAI,CAAC,eAAe,GAAG,OAAO,IAAI,IAAI;AAC9C,IAAI;;AAEJ;AACA;AACA;AACA,IAAI,YAAY,GAAG;AACnB,QAAQ,IAAI,CAAC,WAAW,GAAG,KAAK;AAChC,QAAQ,IAAI,CAAC,eAAe,GAAG,IAAI;AACnC,IAAI;;AAEJ;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAI,eAAe,GAAG;AACtB,QAAQ,OAAO,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC;AACtC,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,WAAW,GAAG;AAClB,QAAQ,OAAO,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,CAAC,CAAC,EAAE,OAAO;AACzE,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,IAAI,SAAS,GAAG;AACpB,QAAQ,OAAO,IAAI,CAAC,aAAa,CAAC,MAAM;AACxC,IAAI;;AAEJ;AACA;AACA;AACA;AACA,IAAI,mBAAmB,GAAG;AAC1B,QAAQ,OAAO,CAAC,GAAG,IAAI,CAAC,iBAAiB,CAAC;AAC1C,IAAI;;AAEJ;AACA;AACA;AACA;AACA;AACA,IAAI,OAAO,CAAC,OAAO,EAAE;AACrB,QAAQ,OAAO,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,EAAE,OAAO,EAAE;AACnD,YAAY,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,GAAG,EAAE,KAAK,CAAC;AACvD,gBAAgB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC,KAAK,IAAI,CAAC,SAAS,CAAC,KAAK;AACrE;AACA,SAAS;AACT,IAAI;;AAEJ;AACA;AACA;AACA;AACA;AACA;AACA,IAAI,MAAM,eAAe,CAAC,KAAK,EAAE,SAAS,GAAG,IAAI,EAAE;AACnD,QAAQ,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE;AAChC,QAAQ,OAAO,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,KAAK,EAAE;AAClD,YAAY,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK,GAAG,SAAS,EAAE;AAChD,gBAAgB,MAAM,IAAI,KAAK,CAAC,CAAC,oBAAoB,EAAE,KAAK,CAAC,eAAe,EAAE,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,CAAC;AAC1G,YAAY;AACZ,YAAY,MAAM,IAAI,OAAO,CAAC,CAAC,IAAI,UAAU,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC;AACrD,QAAQ;AACR,QAAQ,OAAO,IAAI,CAAC,eAAe,EAAE;AACrC,IAAI;;AAEJ;AACA;AACA;AACA,IAAI,KAAK,GAAG;AACZ,QAAQ,IAAI,CAAC,aAAa,GAAG,EAAE;AAC/B,QAAQ,IAAI,CAAC,iBAAiB,GAAG,EAAE;AACnC,IAAI;;AAEJ;AACA;AACA;AACA,IAAI,KAAK,GAAG;AACZ,QAAQ,IAAI,CAAC,KAAK,EAAE;AACpB,QAAQ,IAAI,CAAC,YAAY,EAAE;AAC3B,QAAQ,IAAI,CAAC,SAAS,EAAE;AACxB,IAAI;AACJ;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAAS,oBAAoB,CAAC,OAAO,EAAE,OAAO,EAAE;AACvD,IAAI,MAAM,UAAU,GAAG,IAAI,aAAa,CAAC,OAAO,CAAC;AACjD,IAAI,MAAM,UAAU,GAAG,IAAI,aAAa,CAAC,OAAO,CAAC;;AAEjD;AACA,IAAI,MAAM,aAAa,GAAG,UAAU,CAAC,IAAI;AACzC,IAAI,MAAM,aAAa,GAAG,UAAU,CAAC,IAAI;;AAEzC;AACA,IAAI,MAAM,CAAC,cAAc,CAAC,UAAU,EAAE,MAAM,EAAE;AAC9C,QAAQ,GAAG,GAAG;AACd,YAAY,OAAO,CAAC,OAAO,KAAK;AAChC,gBAAgB,aAAa,CAAC,OAAO,CAAC;AACtC,gBAAgB,UAAU,CAAC,eAAe,CAAC,OAAO,CAAC;AACnD,YAAY,CAAC;AACb,QAAQ;AACR,KAAK,CAAC;;AAEN,IAAI,MAAM,CAAC,cAAc,CAAC,UAAU,EAAE,MAAM,EAAE;AAC9C,QAAQ,GAAG,GAAG;AACd,YAAY,OAAO,CAAC,OAAO,KAAK;AAChC,gBAAgB,aAAa,CAAC,OAAO,CAAC;AACtC,gBAAgB,UAAU,CAAC,eAAe,CAAC,OAAO,CAAC;AACnD,YAAY,CAAC;AACb,QAAQ;AACR,KAAK,CAAC;;AAEN,IAAI,OAAO,EAAE,UAAU,EAAE,UAAU,EAAE;AACrC;;;;"}