{"version":3,"file":"batch.js","sources":["../../src/plugins/batch.js"],"sourcesContent":["/**\n * @fileoverview Message Batching plugin for CrossBus.\n * Collects messages and sends them in batches to reduce postMessage overhead.\n * @module plugins/batch\n */\n\n/**\n * @typedef {Object} BatchOptions\n * @property {number} [windowMs=16] - Time window for batching (default: 1 frame @ 60fps)\n * @property {number} [maxBatchSize=100] - Maximum messages per batch\n * @property {boolean} [useRaf=true] - Use requestAnimationFrame for timing\n */\n\n/**\n * Message Batcher for high-frequency messaging scenarios.\n * \n * Instead of sending each message immediately, this plugin:\n * 1. Queues messages for a short time window (default: 16ms / 1 frame)\n * 2. Sends all messages as a single batch\n * 3. Automatically unbatches on the receiving side\n * \n * **Performance Impact:**\n * - 2-5x throughput improvement for high-frequency signals\n * - Reduces postMessage call overhead\n * - Ideal for streaming data, telemetry, mouse/touch events\n * \n * @example\n * import { CrossBus } from 'crossbus';\n * import { withBatching } from 'crossbus/plugins/batch';\n * \n * const bus = new CrossBus({ peerId: 'sender' });\n * withBatching(bus, { windowMs: 16 });\n * \n * // These 100 signals are sent as ~6 batches instead of 100 calls\n * for (let i = 0; i < 100; i++) {\n *   bus.signal('telemetry', { value: i });\n * }\n */\nexport class MessageBatcher {\n    /** @type {number} */\n    #windowMs;\n\n    /** @type {number} */\n    #maxBatchSize;\n\n    /** @type {boolean} */\n    #useRaf;\n\n    /** @type {Map<string, Object[]>} Batches per peer */\n    #batches = new Map();\n\n    /** @type {ReturnType<typeof setTimeout>|number|null} */\n    #flushTimer = null;\n\n    /** @type {boolean} */\n    #flushScheduled = false;\n\n    /** @type {((batch: Object[]) => void)|null} */\n    #sendFn = null;\n\n    /** @type {number} */\n    #batchesSent = 0;\n\n    /** @type {number} */\n    #messagesBatched = 0;\n\n    /**\n     * Creates a new MessageBatcher.\n     * \n     * @param {BatchOptions} [options={}]\n     */\n    constructor(options = {}) {\n        this.#windowMs = options.windowMs ?? 16;\n        this.#maxBatchSize = options.maxBatchSize ?? 100;\n        this.#useRaf = options.useRaf ?? (typeof requestAnimationFrame !== 'undefined');\n    }\n\n    /**\n     * Queues a message for batching.\n     * \n     * @param {Object} message - Message to queue\n     * @returns {boolean} True if message was queued\n     */\n    queue(message) {\n        const key = 'default';  // Could be per-peer in future\n\n        if (!this.#batches.has(key)) {\n            this.#batches.set(key, []);\n        }\n\n        const batch = this.#batches.get(key);\n        if (batch) {\n            batch.push(message);\n            this.#messagesBatched++;\n\n            // Flush if batch is full\n            if (batch.length >= this.#maxBatchSize) {\n                this.#flushBatch(key);\n            } else if (!this.#flushScheduled) {\n                this.#scheduleFlush();\n            }\n        }\n\n        return true;\n    }\n\n    /**\n     * Sets the function to call when flushing batches.\n     * \n     * @param {(batch: Object[]) => void} fn\n     */\n    onFlush(fn) {\n        this.#sendFn = fn;\n    }\n\n    /**\n     * Manually flushes all pending batches.\n     */\n    flush() {\n        for (const key of this.#batches.keys()) {\n            this.#flushBatch(key);\n        }\n    }\n\n    /**\n     * Gets statistics.\n     */\n    get stats() {\n        return {\n            batchesSent: this.#batchesSent,\n            messagesBatched: this.#messagesBatched,\n            pendingMessages: this.#getPendingCount(),\n            avgBatchSize: this.#batchesSent > 0\n                ? Math.round(this.#messagesBatched / this.#batchesSent)\n                : 0\n        };\n    }\n\n    /**\n     * Resets statistics.\n     */\n    resetStats() {\n        this.#batchesSent = 0;\n        this.#messagesBatched = 0;\n    }\n\n    /**\n     * Destroys the batcher.\n     */\n    destroy() {\n        if (this.#flushTimer !== null) {\n            if (this.#useRaf && typeof cancelAnimationFrame !== 'undefined') {\n                cancelAnimationFrame(/** @type {number} */(this.#flushTimer));\n            } else {\n                clearTimeout(/** @type {ReturnType<typeof setTimeout>} */(this.#flushTimer));\n            }\n        }\n        this.#batches.clear();\n        this.#sendFn = null;\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Private methods\n    // ─────────────────────────────────────────────────────────────────\n\n    #scheduleFlush() {\n        this.#flushScheduled = true;\n\n        if (this.#useRaf && typeof requestAnimationFrame !== 'undefined') {\n            this.#flushTimer = requestAnimationFrame(() => {\n                this.#flushScheduled = false;\n                this.flush();\n            });\n        } else {\n            this.#flushTimer = setTimeout(() => {\n                this.#flushScheduled = false;\n                this.flush();\n            }, this.#windowMs);\n        }\n    }\n\n    #flushBatch(key) {\n        const batch = this.#batches.get(key);\n        if (!batch || batch.length === 0) return;\n\n        if (this.#sendFn) {\n            this.#sendFn(batch);\n            this.#batchesSent++;\n        }\n\n        this.#batches.set(key, []);\n    }\n\n    #getPendingCount() {\n        let count = 0;\n        for (const batch of this.#batches.values()) {\n            count += batch.length;\n        }\n        return count;\n    }\n}\n\n/**\n * Batch envelope type marker.\n */\nexport const BATCH_TYPE = '__crossbus_batch__';\n\n/**\n * Wraps a CrossBus to batch outgoing signals.\n * \n * @param {import('../core/cross-bus.js').CrossBus} bus - CrossBus instance\n * @param {BatchOptions} [options={}]\n * @returns {import('../core/cross-bus.js').CrossBus} Same bus with batching installed\n * \n * @example\n * const bus = new CrossBus({ peerId: 'high-freq-sender' });\n * withBatching(bus, { windowMs: 16 });\n * \n * // Rapid signals are now batched\n * for (let i = 0; i < 1000; i++) {\n *   bus.signal('data', { n: i });\n * }\n */\nexport function withBatching(bus, options = {}) {\n    const batcher = new MessageBatcher(options);\n\n    // Wrap the signal method\n    const originalSignal = bus.signal.bind(bus);\n\n    batcher.onFlush((batch) => {\n        // Send batch as a single message\n        originalSignal(BATCH_TYPE, { messages: batch });\n    });\n\n    // Override signal to queue\n    /** @type {any} */ (bus).signal = (/** @type {string} */ event, /** @type {any} */ data) => {\n        batcher.queue({ event, data });\n    };\n\n    // Add inbound hook to unbatch\n    bus.addInboundHook((payload, context) => {\n        if (payload && payload.messages && Array.isArray(payload.messages)) {\n            // Emit each message in the batch\n            for (const msg of payload.messages) {\n                bus.emit(msg.event, msg.data);\n            }\n            return null; // Don't pass batch through\n        }\n        return payload;\n    });\n\n    // Expose batcher for stats/control\n    // @ts-ignore - adding custom property\n    bus._batcher = batcher;\n\n    return bus;\n}\n\n/**\n * Creates a standalone batcher for custom use cases.\n * \n * @param {BatchOptions} options\n * @returns {MessageBatcher}\n */\nexport function createBatcher(options = {}) {\n    return new MessageBatcher(options);\n}\n"],"names":[],"mappings":"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"}