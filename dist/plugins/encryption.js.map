{"version":3,"file":"encryption.js","sources":["../../src/plugins/encryption.js"],"sourcesContent":["/**\n * @fileoverview Encryption plugin for CrossBus.\n * Provides AES-GCM encryption for message payloads using Web Crypto API.\n * \n * @module plugins/encryption\n */\n\n/**\n * @typedef {Object} EncryptedPayload\n * @property {boolean} _encrypted - Marker indicating encrypted content\n * @property {string} ciphertext - Base64-encoded encrypted data\n * @property {string} iv - Base64-encoded initialization vector\n */\n\n/**\n * @typedef {Object} EncryptionOptions\n * @property {boolean} [enabled=true] - Whether encryption is enabled\n */\n\n/**\n * Encryption utilities for CrossBus messages.\n * Uses AES-256-GCM for authenticated encryption.\n * \n * @example\n * import { Encryption } from 'crossbus/plugins/encryption';\n * \n * // Generate or derive a key\n * const key = await Encryption.generateKey();\n * // or: const key = await Encryption.deriveKey('password', 'salt');\n * \n * // Use with CrossBus hooks\n * const { encryptHook, decryptHook } = Encryption.createEncryptedHooks(key);\n * bus.addOutboundHook(encryptHook);\n * bus.addInboundHook(decryptHook);\n * \n * // Now all messages are automatically encrypted!\n */\nexport class Encryption {\n    static ALGORITHM = 'AES-GCM';\n    static KEY_LENGTH = 256;\n    static IV_LENGTH = 12; // 96 bits recommended for GCM\n\n    /**\n     * Generates a new random AES-256 key.\n     * \n     * @returns {Promise<CryptoKey>} Generated key\n     */\n    static async generateKey() {\n        return await crypto.subtle.generateKey(\n            {\n                name: this.ALGORITHM,\n                length: this.KEY_LENGTH\n            },\n            true, // extractable\n            ['encrypt', 'decrypt']\n        );\n    }\n\n    /**\n     * Derives a key from a password using PBKDF2.\n     * \n     * @param {string} password - User password\n     * @param {string} salt - Salt for key derivation (should be unique per user/session)\n     * @param {number} [iterations=100000] - PBKDF2 iterations\n     * @returns {Promise<CryptoKey>} Derived key\n     */\n    static async deriveKey(password, salt, iterations = 100000) {\n        const encoder = new TextEncoder();\n\n        // Import password as key material\n        const keyMaterial = await crypto.subtle.importKey(\n            'raw',\n            encoder.encode(password),\n            'PBKDF2',\n            false,\n            ['deriveKey']\n        );\n\n        // Derive AES key\n        return await crypto.subtle.deriveKey(\n            {\n                name: 'PBKDF2',\n                salt: encoder.encode(salt),\n                iterations,\n                hash: 'SHA-256'\n            },\n            keyMaterial,\n            {\n                name: this.ALGORITHM,\n                length: this.KEY_LENGTH\n            },\n            true,\n            ['encrypt', 'decrypt']\n        );\n    }\n\n    /**\n     * Exports a CryptoKey to base64 string for storage.\n     * \n     * @param {CryptoKey} key - Key to export\n     * @returns {Promise<string>} Base64-encoded key\n     */\n    static async exportKey(key) {\n        const exported = await crypto.subtle.exportKey('raw', key);\n        return this.#arrayBufferToBase64(exported);\n    }\n\n    /**\n     * Imports a key from base64 string.\n     * \n     * @param {string} keyStr - Base64-encoded key\n     * @returns {Promise<CryptoKey>} Imported key\n     */\n    static async importKey(keyStr) {\n        const keyData = this.#base64ToArrayBuffer(keyStr);\n        return await crypto.subtle.importKey(\n            'raw',\n            keyData,\n            {\n                name: this.ALGORITHM,\n                length: this.KEY_LENGTH\n            },\n            true,\n            ['encrypt', 'decrypt']\n        );\n    }\n\n    /**\n     * Encrypts a payload.\n     * \n     * @param {any} payload - Data to encrypt (will be JSON serialized)\n     * @param {CryptoKey} key - Encryption key\n     * @returns {Promise<EncryptedPayload>} Encrypted payload\n     */\n    static async encrypt(payload, key) {\n        // Wrap payload with timestamp for replay protection\n        const wrapped = {\n            data: payload,\n            _ts: Date.now()\n        };\n\n        const encoder = new TextEncoder();\n        const data = encoder.encode(JSON.stringify(wrapped));\n\n        // Generate random IV\n        const iv = crypto.getRandomValues(new Uint8Array(this.IV_LENGTH));\n\n        // Encrypt\n        const ciphertext = await crypto.subtle.encrypt(\n            {\n                name: this.ALGORITHM,\n                iv\n            },\n            key,\n            data\n        );\n\n        return {\n            _encrypted: true,\n            ciphertext: this.#arrayBufferToBase64(ciphertext),\n            iv: this.#arrayBufferToBase64(iv)\n        };\n    }\n\n    /**\n     * Decrypts an encrypted payload.\n     * \n     * @param {EncryptedPayload} encrypted - Encrypted payload\n     * @param {CryptoKey} key - Decryption key\n     * @param {Object} [options={}] - Decryption options\n     * @param {number} [options.ttl=60000] - Time-to-live window in ms (replay protection)\n     * @returns {Promise<any>} Decrypted payload\n     * @throws {Error} If message is expired (replay attack)\n     */\n    static async decrypt(encrypted, key, options = {}) {\n        const ciphertext = this.#base64ToArrayBuffer(encrypted.ciphertext);\n        const iv = this.#base64ToArrayBuffer(encrypted.iv);\n\n        const decrypted = await crypto.subtle.decrypt(\n            {\n                name: this.ALGORITHM,\n                iv\n            },\n            key,\n            ciphertext\n        );\n\n        const decoder = new TextDecoder();\n        const unwrapped = JSON.parse(decoder.decode(decrypted));\n\n        // Handle legacy payloads (no timestamp) vs new wrapped payloads\n        const payload = unwrapped._ts ? unwrapped.data : unwrapped;\n        const timestamp = unwrapped._ts;\n\n        // Replay protection check\n        if (timestamp) {\n            const ttl = options.ttl ?? 60000;\n            const now = Date.now();\n\n            // Check if expired\n            if (now - timestamp > ttl) {\n                throw new Error(`Message expired (replay attack detected). Age: ${now - timestamp}ms, TTL: ${ttl}ms`);\n            }\n\n            // Check for future timestamps (clock skew/manipulation)\n            if (timestamp > now + 5000) { // Allow 5s slack\n                console.warn('[CrossBus] Detected future timestamp in encrypted message (clock skew?)');\n            }\n        }\n\n        return payload;\n    }\n\n    /**\n     * Creates hook functions for automatic encryption/decryption.\n     * \n     * @param {CryptoKey} key - Encryption key\n     * @returns {{ encryptHook: import('../core/cross-bus.js').MessageHook, decryptHook: import('../core/cross-bus.js').MessageHook }}\n     * \n     * @example\n     * const { encryptHook, decryptHook } = Encryption.createEncryptedHooks(key);\n     * bus.addOutboundHook(encryptHook);\n     * bus.addInboundHook(decryptHook);\n     */\n    static createEncryptedHooks(key) {\n        return {\n            encryptHook: async (payload, context) => {\n                // Skip if already encrypted\n                if (payload && payload._encrypted) return payload;\n                return await this.encrypt(payload, key);\n            },\n\n            decryptHook: async (payload, context) => {\n                // Skip if not encrypted\n                if (!payload || !payload._encrypted) return payload;\n                return await this.decrypt(payload, key);\n            }\n        };\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Private helpers\n    // ─────────────────────────────────────────────────────────────────\n\n    static #arrayBufferToBase64(buffer) {\n        const bytes = new Uint8Array(buffer);\n        let binary = '';\n        for (let i = 0; i < bytes.length; i++) {\n            binary += String.fromCharCode(bytes[i]);\n        }\n        return btoa(binary);\n    }\n\n    static #base64ToArrayBuffer(base64) {\n        const binary = atob(base64);\n        const bytes = new Uint8Array(binary.length);\n        for (let i = 0; i < binary.length; i++) {\n            bytes[i] = binary.charCodeAt(i);\n        }\n        return bytes.buffer;\n    }\n}\n\n/**\n * Helper to create an encrypted CrossBus instance.\n * \n * @param {import(\"../core/cross-bus.js\").CrossBus} bus - CrossBus instance\n * @param {CryptoKey} key - Encryption key\n * @returns {import(\"../core/cross-bus.js\").CrossBus} Same bus with encryption hooks installed\n * \n * @example\n * const bus = new CrossBus({ peerId: 'secure-agent' });\n * const key = await Encryption.deriveKey('password', 'salt');\n * withEncryption(bus, key);\n * // All messages now encrypted automatically\n */\nexport function withEncryption(bus, key) {\n    const { encryptHook, decryptHook } = Encryption.createEncryptedHooks(key);\n    bus.addOutboundHook(encryptHook);\n    bus.addInboundHook(decryptHook);\n    return bus;\n}\n"],"names":[],"mappings":"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"}