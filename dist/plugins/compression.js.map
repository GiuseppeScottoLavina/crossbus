{"version":3,"file":"compression.js","sources":["../../src/plugins/compression.js"],"sourcesContent":["/**\n * @fileoverview Compression plugin for CrossBus.\n * Compresses message payloads using CompressionStream API.\n * \n * @module plugins/compression\n */\n\n/**\n * @typedef {Object} CompressedPayload\n * @property {boolean} _compressed - Marker indicating compressed content\n * @property {string} data - Base64-encoded compressed data\n * @property {string} algorithm - Compression algorithm used\n */\n\n/**\n * @typedef {Object} CompressionOptions\n * @property {'gzip' | 'deflate' | 'deflate-raw'} [algorithm='gzip'] - Compression algorithm\n * @property {number} [threshold=0] - Minimum payload size to compress (bytes)\n */\n\n/**\n * @typedef {Object} CompressionStream\n * @property {WritableStream} writable\n * @property {ReadableStream} readable\n */\n\n/**\n * @typedef {Object} DecompressionStream\n * @property {WritableStream} writable\n * @property {ReadableStream} readable\n */\n\n/**\n * @typedef {'gzip' | 'deflate' | 'deflate-raw'} CompressionFormat\n */\n\n/**\n * Compression utilities for CrossBus messages.\n * Uses native CompressionStream API for efficiency.\n * \n * @example\n * import { Compression } from 'crossbus/plugins/compression';\n * \n * // Use with CrossBus hooks\n * const { compressHook, decompressHook } = Compression.createCompressedHooks();\n * bus.addOutboundHook(compressHook);\n * bus.addInboundHook(decompressHook);\n * \n * // Now large messages are automatically compressed!\n */\nexport class Compression {\n    static DEFAULT_ALGORITHM = 'gzip';\n\n    /**\n     * Checks if CompressionStream API is supported.\n     * \n     * @returns {boolean}\n     */\n    static isSupported() {\n        return typeof CompressionStream !== 'undefined' &&\n            typeof DecompressionStream !== 'undefined';\n    }\n\n    /**\n     * Estimates the size of a payload in bytes.\n     * \n     * @param {any} payload - Payload to estimate\n     * @returns {number} Estimated size in bytes\n     */\n    static estimateSize(payload) {\n        const json = JSON.stringify(payload);\n        return new TextEncoder().encode(json).length;\n    }\n\n    /**\n     * Compresses a payload.\n     * \n     * @param {any} payload - Data to compress (will be JSON serialized)\n     * @param {CompressionOptions} [options={}] - Compression options\n     * @returns {Promise<CompressedPayload>} Compressed payload\n     */\n    static async compress(payload, options = {}) {\n        const algorithm = options.algorithm ?? this.DEFAULT_ALGORITHM;\n\n        const encoder = new TextEncoder();\n        const data = encoder.encode(JSON.stringify(payload));\n\n        // Create compression stream\n        // @ts-ignore - Types not yet in all TS libs\n        const cs = new CompressionStream(/** @type {any} */(algorithm));\n        const writer = cs.writable.getWriter();\n        const reader = cs.readable.getReader();\n\n        // Write data\n        writer.write(data);\n        writer.close();\n\n        // Read compressed chunks\n        const chunks = [];\n        while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n            chunks.push(value);\n        }\n\n        // Combine chunks\n        const compressed = new Uint8Array(\n            chunks.reduce((acc, chunk) => acc + chunk.length, 0)\n        );\n        let offset = 0;\n        for (const chunk of chunks) {\n            compressed.set(chunk, offset);\n            offset += chunk.length;\n        }\n\n        return {\n            _compressed: true,\n            data: this.#arrayBufferToBase64(compressed.buffer),\n            algorithm\n        };\n    }\n\n    /**\n     * Decompresses a compressed payload.\n     * \n     * @param {CompressedPayload} compressed - Compressed payload\n     * @returns {Promise<any>} Decompressed payload\n     */\n    static async decompress(compressed) {\n        const algorithm = compressed.algorithm ?? this.DEFAULT_ALGORITHM;\n        const data = this.#base64ToArrayBuffer(compressed.data);\n\n        // Create decompression stream\n        // @ts-ignore - Types not yet in all TS libs\n        const ds = new DecompressionStream(/** @type {any} */(algorithm));\n        const writer = ds.writable.getWriter();\n        const reader = ds.readable.getReader();\n\n        // Write compressed data\n        writer.write(new Uint8Array(data));\n        writer.close();\n\n        // Read decompressed chunks\n        const chunks = [];\n        while (true) {\n            const { done, value } = await reader.read();\n            if (done) break;\n            chunks.push(value);\n        }\n\n        // Combine chunks\n        const decompressed = new Uint8Array(\n            chunks.reduce((acc, chunk) => acc + chunk.length, 0)\n        );\n        let offset = 0;\n        for (const chunk of chunks) {\n            decompressed.set(chunk, offset);\n            offset += chunk.length;\n        }\n\n        const decoder = new TextDecoder();\n        return JSON.parse(decoder.decode(decompressed));\n    }\n\n    /**\n     * Creates hook functions for automatic compression/decompression.\n     * \n     * @param {CompressionOptions} [options={}] - Compression options\n     * @returns {{ compressHook: import('../core/cross-bus.js').MessageHook, decompressHook: import('../core/cross-bus.js').MessageHook }}\n     * \n     * @example\n     * const { compressHook, decompressHook } = Compression.createCompressedHooks({\n     *   algorithm: 'gzip',\n     *   threshold: 1024 // Only compress payloads > 1KB\n     * });\n     * bus.addOutboundHook(compressHook);\n     * bus.addInboundHook(decompressHook);\n     */\n    static createCompressedHooks(options = {}) {\n        const { threshold = 0, algorithm = this.DEFAULT_ALGORITHM } = options;\n\n        return {\n            compressHook: async (payload, context) => {\n                // Skip if already compressed\n                if (payload && payload._compressed) return payload;\n\n                // Skip if below threshold\n                if (threshold > 0 && this.estimateSize(payload) < threshold) {\n                    return payload;\n                }\n\n                return await this.compress(payload, { algorithm: /** @type {CompressionFormat} */(algorithm) });\n            },\n\n            decompressHook: async (payload, context) => {\n                // Skip if not compressed\n                if (!payload || !payload._compressed) return payload;\n                return await this.decompress(payload);\n            }\n        };\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Private helpers\n    // ─────────────────────────────────────────────────────────────────\n\n    static #arrayBufferToBase64(buffer) {\n        const bytes = new Uint8Array(buffer);\n        let binary = '';\n        for (let i = 0; i < bytes.length; i++) {\n            binary += String.fromCharCode(bytes[i]);\n        }\n        return btoa(binary);\n    }\n\n    static #base64ToArrayBuffer(base64) {\n        const binary = atob(base64);\n        const bytes = new Uint8Array(binary.length);\n        for (let i = 0; i < binary.length; i++) {\n            bytes[i] = binary.charCodeAt(i);\n        }\n        return bytes.buffer;\n    }\n}\n\n/**\n * Helper to add compression to a CrossBus instance.\n * \n * @param {import(\"../core/cross-bus.js\").CrossBus} bus - CrossBus instance\n * @param {CompressionOptions} [options={}] - Compression options\n * @returns {import(\"../core/cross-bus.js\").CrossBus} Same bus with compression hooks installed\n * \n * @example\n * withCompression(bus, { threshold: 1024 });\n * // Large messages now compressed automatically\n */\nexport function withCompression(bus, options = {}) {\n    const { compressHook, decompressHook } = Compression.createCompressedHooks(options);\n    bus.addOutboundHook(compressHook);\n    bus.addInboundHook(decompressHook);\n    return bus;\n}\n"],"names":[],"mappings":"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"}