{"version":3,"file":"rate-limiter.js","sources":["../../src/plugins/rate-limiter.js"],"sourcesContent":["/**\n * @fileoverview Rate Limiter plugin for CrossBus.\n * Prevents message flooding with configurable rate limits.\n * \n * @module plugins/rate-limiter\n */\n\n/**\n * @typedef {Object} RateLimiterOptions\n * @property {number} [maxRequests=100] - Maximum requests per window\n * @property {number} [windowMs=1000] - Time window in milliseconds\n * @property {string} [strategy='sliding'] - 'sliding' or 'fixed' window\n * @property {Function|null} [onLimitExceeded] - Called when limit exceeded\n */\n\n/**\n * Custom error for rate limiting\n * @extends Error\n */\nclass RateLimitError extends Error {\n    /** @type {string} */\n    code;\n    /** @type {number} */\n    retryAfter;\n\n    /**\n     * @param {string} message \n     * @param {number} retryAfter \n     */\n    constructor(message, retryAfter) {\n        super(message);\n        this.code = 'ERR_RATE_LIMITED';\n        this.retryAfter = retryAfter;\n    }\n}\n\n/**\n * Rate limiter using token bucket algorithm.\n * \n * @example\n * import { RateLimiter } from 'crossbus/plugins/rate-limiter';\n * \n * const limiter = new RateLimiter({\n *   maxRequests: 100,\n *   windowMs: 1000 // 100 requests per second\n * });\n * \n * // Check before sending\n * if (limiter.tryAcquire()) {\n *   await bus.emit('event', data);\n * } else {\n *   console.log('Rate limited!');\n * }\n * \n * // Or use as hook\n * bus.addOutboundHook(limiter.createHook());\n */\nexport class RateLimiter {\n    /** @type {number} */\n    #maxTokens;\n\n    /** @type {number} */\n    #tokens;\n\n    /** @type {number} */\n    #windowMs;\n\n    /** @type {number} */\n    #lastRefill;\n\n    /** @type {Function|null} */\n    #onLimitExceeded;\n\n    /** @type {Map<string, RateLimiter>} */\n    #perPeerLimiters = new Map();\n\n    /**\n     * Creates a new rate limiter.\n     * \n     * @param {RateLimiterOptions} [options={}]\n     */\n    constructor(options = {}) {\n        this.#maxTokens = options.maxRequests ?? 100;\n        this.#tokens = this.#maxTokens;\n        this.#windowMs = options.windowMs ?? 1000;\n        this.#lastRefill = Date.now();\n        this.#onLimitExceeded = options.onLimitExceeded ?? null;\n    }\n\n    /**\n     * Attempts to acquire a token.\n     * \n     * @returns {boolean} True if request allowed, false if rate limited\n     */\n    tryAcquire() {\n        this.#refill();\n\n        if (this.#tokens > 0) {\n            this.#tokens--;\n            return true;\n        }\n\n        if (this.#onLimitExceeded) {\n            this.#onLimitExceeded();\n        }\n\n        return false;\n    }\n\n    /**\n     * Gets remaining tokens.\n     * @returns {number}\n     */\n    get remaining() {\n        this.#refill();\n        return this.#tokens;\n    }\n\n    /**\n     * Gets time until next token is available.\n     * @returns {number} Milliseconds until next refill\n     */\n    get retryAfter() {\n        const now = Date.now();\n        const elapsed = now - this.#lastRefill;\n        return Math.max(0, this.#windowMs - elapsed);\n    }\n\n    /**\n     * Resets the rate limiter.\n     */\n    reset() {\n        this.#tokens = this.#maxTokens;\n        this.#lastRefill = Date.now();\n    }\n\n    /**\n     * Creates a per-peer rate limiter.\n     * Each peer gets its own token bucket.\n     * \n     * @param {string} peerId - Peer identifier\n     * @returns {RateLimiter}\n     */\n    forPeer(peerId) {\n        if (!this.#perPeerLimiters.has(peerId)) {\n            this.#perPeerLimiters.set(peerId, new RateLimiter({\n                maxRequests: this.#maxTokens,\n                windowMs: this.#windowMs,\n                onLimitExceeded: this.#onLimitExceeded\n            }));\n        }\n        return /** @type {RateLimiter} */ (this.#perPeerLimiters.get(peerId));\n    }\n\n    /**\n     * Creates a hook function for automatic rate limiting.\n     * \n     * @param {{ perPeer?: boolean, throwOnLimit?: boolean }} [options={}]\n     * @returns {import('../core/cross-bus.js').MessageHook} Hook function\n     * \n     * @example\n     * bus.addOutboundHook(limiter.createHook({ perPeer: true }));\n     */\n    createHook(options = {}) {\n        const { perPeer = false, throwOnLimit = true } = options;\n\n        return (payload, context) => {\n            const limiter = perPeer && context.peerId\n                ? this.forPeer(context.peerId)\n                : this;\n\n            if (!limiter.tryAcquire()) {\n                if (throwOnLimit) {\n                    throw new RateLimitError('Rate limit exceeded', limiter.retryAfter);\n                }\n                return null; // Drop message\n            }\n\n            return payload;\n        };\n    }\n\n    /**\n     * Cleans up per-peer limiters for disconnected peers.\n     * \n     * @param {string[]} activePeers - List of currently active peer IDs\n     */\n    cleanup(activePeers) {\n        const activeSet = new Set(activePeers);\n        for (const peerId of this.#perPeerLimiters.keys()) {\n            if (!activeSet.has(peerId)) {\n                this.#perPeerLimiters.delete(peerId);\n            }\n        }\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Private methods\n    // ─────────────────────────────────────────────────────────────────\n\n    #refill() {\n        const now = Date.now();\n        const elapsed = now - this.#lastRefill;\n\n        if (elapsed >= this.#windowMs) {\n            // Full refill\n            this.#tokens = this.#maxTokens;\n            this.#lastRefill = now;\n        } else {\n            // Sliding window: proportional refill\n            const tokensToAdd = Math.floor((elapsed / this.#windowMs) * this.#maxTokens);\n            if (tokensToAdd > 0) {\n                this.#tokens = Math.min(this.#maxTokens, this.#tokens + tokensToAdd);\n                this.#lastRefill = now;\n            }\n        }\n    }\n}\n\n/**\n * Helper to rate limit a CrossBus instance.\n * \n * @param {import(\"../core/cross-bus.js\").CrossBus} bus - CrossBus instance\n * @param {RateLimiterOptions} options - Rate limiter options\n * @returns {RateLimiter} The rate limiter (for inspection)\n * \n * @example\n * const limiter = withRateLimiter(bus, { \n *   maxRequests: 50, \n *   windowMs: 1000 \n * });\n */\nexport function withRateLimiter(bus, options = {}) {\n    const limiter = new RateLimiter(options);\n    bus.addOutboundHook(limiter.createHook({ perPeer: true }));\n    return limiter;\n}\n"],"names":[],"mappings":"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"}