{"version":3,"file":"circuit-breaker.min.js","sources":["../../src/plugins/circuit-breaker.js","../../src/common/errors.js"],"sourcesContent":["/**\n * @fileoverview Circuit Breaker plugin for CrossBus.\n * Prevents cascading failures by tracking errors and opening circuit.\n * @module plugins/circuit-breaker\n */\n\nimport { CrossBusError, ErrorCode } from '../common/errors.js';\n\n/**\n * Circuit breaker states.\n */\nexport const CircuitState = Object.freeze({\n    CLOSED: 'closed',     // Normal operation, requests flow through\n    OPEN: 'open',         // Circuit tripped, requests fail fast\n    HALF_OPEN: 'half_open' // Testing if service recovered\n});\n\n/**\n * @typedef {Object} CircuitBreakerOptions\n * @property {number} [failureThreshold=5] - Failures before opening circuit.\n * @property {number} [successThreshold=2] - Successes needed to close from half-open.\n * @property {number} [resetTimeout=30000] - Time in ms before trying half-open.\n * @property {Function|null} [onStateChange] - Callback when state changes.\n * @property {Function} [isFailure] - Custom failure detector.\n */\n\n/**\n * Default circuit breaker options.\n */\nexport const DEFAULT_CIRCUIT_OPTIONS = {\n    failureThreshold: 5,\n    successThreshold: 2,\n    resetTimeout: 30000,\n    onStateChange: null,\n    isFailure: (error) => true // All errors count as failures by default\n};\n\n/**\n * Circuit Breaker implementation.\n * \n * States:\n * - CLOSED: Normal operation, tracking failures\n * - OPEN: Circuit tripped, all requests fail fast\n * - HALF_OPEN: Allowing test requests to check recovery\n * \n * @example\n * const breaker = new CircuitBreaker({\n *   failureThreshold: 3,\n *   resetTimeout: 10000\n * });\n * \n * try {\n *   const result = await breaker.execute(() => \n *     bus.request('unstable-service', 'getData')\n *   );\n * } catch (error) {\n *   if (error.code === 'ERR_CIRCUIT_OPEN') {\n *     // Circuit is open, service unavailable\n *   }\n * }\n */\nexport class CircuitBreaker {\n    /** @type {string} */\n    #state = CircuitState.CLOSED;\n\n    /** @type {number} */\n    #failures = 0;\n\n    /** @type {number} */\n    #successes = 0;\n\n    /** @type {number|null} */\n    #lastFailureTime = null;\n\n    /** @type {number|null} */\n    #openedAt = null;\n\n    /** @type {CircuitBreakerOptions} */\n    #options;\n\n    /** @type {number} */\n    #totalRequests = 0;\n\n    /** @type {number} */\n    #totalFailures = 0;\n\n    /** @type {number} */\n    #totalSuccesses = 0;\n\n    /**\n     * Creates a new circuit breaker.\n     * \n     * @param {CircuitBreakerOptions} [options={}]\n     */\n    constructor(options = {}) {\n        this.#options = { ...DEFAULT_CIRCUIT_OPTIONS, ...options };\n    }\n\n    /**\n     * Gets current circuit state.\n     * @returns {string}\n     */\n    get state() {\n        this.#checkHalfOpen();\n        return this.#state;\n    }\n\n    /**\n     * Gets failure count in current period.\n     * @returns {number}\n     */\n    get failures() {\n        return this.#failures;\n    }\n\n    /**\n     * Gets circuit statistics.\n     * @returns {Object}\n     */\n    get stats() {\n        return {\n            state: this.state,\n            failures: this.#failures,\n            successes: this.#successes,\n            totalRequests: this.#totalRequests,\n            totalFailures: this.#totalFailures,\n            totalSuccesses: this.#totalSuccesses,\n            lastFailureTime: this.#lastFailureTime,\n            openedAt: this.#openedAt\n        };\n    }\n\n    /**\n     * Checks if the circuit allows requests.\n     * @returns {boolean}\n     */\n    get isOpen() {\n        return this.state === CircuitState.OPEN;\n    }\n\n    /**\n     * Checks if the circuit is closed (normal operation).\n     * @returns {boolean}\n     */\n    get isClosed() {\n        return this.state === CircuitState.CLOSED;\n    }\n\n    /**\n     * Executes a function through the circuit breaker.\n     * \n     * @template T\n     * @param {() => Promise<T>} fn - Function to execute.\n     * @returns {Promise<T>}\n     * @throws {CrossBusError} When circuit is open.\n     * \n     * @example\n     * const result = await breaker.execute(async () => {\n     *   return await bus.request('service', 'method');\n     * });\n     */\n    async execute(fn) {\n        this.#totalRequests++;\n\n        // Check if circuit allows request\n        const currentState = this.state;\n\n        if (currentState === CircuitState.OPEN) {\n            throw CrossBusError.from(ErrorCode.CIRCUIT_OPEN, {\n                state: this.#state,\n                openedAt: this.#openedAt,\n                failures: this.#failures\n            });\n        }\n\n        try {\n            const result = await fn();\n            this.#onSuccess();\n            return result;\n        } catch (error) {\n            // Check if this error should count as failure\n            if (this.#options.isFailure && this.#options.isFailure(error)) {\n                this.#onFailure();\n            }\n            throw error;\n        }\n    }\n\n    /**\n     * Manually resets the circuit to closed state.\n     */\n    reset() {\n        const previousState = this.#state;\n        this.#state = CircuitState.CLOSED;\n        this.#failures = 0;\n        this.#successes = 0;\n        this.#openedAt = null;\n\n        if (previousState !== CircuitState.CLOSED) {\n            this.#notifyStateChange(previousState, CircuitState.CLOSED);\n        }\n    }\n\n    /**\n     * Manually trips the circuit to open state.\n     */\n    trip() {\n        const previousState = this.#state;\n        if (previousState === CircuitState.OPEN) return;\n\n        this.#state = CircuitState.OPEN;\n        this.#openedAt = Date.now();\n        this.#notifyStateChange(previousState, CircuitState.OPEN);\n    }\n\n    // ─────────────────────────────────────────────────────────────────\n    // Private methods\n    // ─────────────────────────────────────────────────────────────────\n\n    /**\n     * Handles successful execution.\n     * \n     */\n    #onSuccess() {\n        this.#totalSuccesses++;\n\n        if (this.#state === CircuitState.HALF_OPEN) {\n            this.#successes++;\n\n            if (this.#successes >= (this.#options.successThreshold || 2)) {\n                // Recovered! Close the circuit\n                const previousState = this.#state;\n                this.#state = CircuitState.CLOSED;\n                this.#failures = 0;\n                this.#successes = 0;\n                this.#openedAt = null;\n                this.#notifyStateChange(previousState, CircuitState.CLOSED);\n            }\n        } else if (this.#state === CircuitState.CLOSED) {\n            // Reset failure count on success in closed state\n            this.#failures = 0;\n        }\n    }\n\n    /**\n     * Handles failed execution.\n     * \n     */\n    #onFailure() {\n        this.#totalFailures++;\n        this.#lastFailureTime = Date.now();\n        this.#failures++;\n\n        if (this.#state === CircuitState.HALF_OPEN) {\n            // Failed during test, go back to open\n            const previousState = this.#state;\n            this.#state = CircuitState.OPEN;\n            this.#openedAt = Date.now();\n            this.#successes = 0;\n            this.#notifyStateChange(previousState, CircuitState.OPEN);\n        } else if (this.#state === CircuitState.CLOSED) {\n            if (this.#failures >= (this.#options.failureThreshold || 5)) {\n                // Too many failures, trip the circuit\n                const previousState = this.#state;\n                this.#state = CircuitState.OPEN;\n                this.#openedAt = Date.now();\n                this.#notifyStateChange(previousState, CircuitState.OPEN);\n            }\n        }\n    }\n\n    /**\n     * Checks if circuit should transition to half-open.\n     * \n     */\n    #checkHalfOpen() {\n        if (this.#state === CircuitState.OPEN && this.#openedAt) {\n            const elapsed = Date.now() - this.#openedAt;\n\n            if (elapsed >= (this.#options.resetTimeout || 30000)) {\n                const previousState = this.#state;\n                this.#state = CircuitState.HALF_OPEN;\n                this.#successes = 0;\n                this.#notifyStateChange(previousState, CircuitState.HALF_OPEN);\n            }\n        }\n    }\n\n    /**\n     * Notifies state change callback.\n     * \n     */\n    #notifyStateChange(from, to) {\n        if (this.#options.onStateChange) {\n            this.#options.onStateChange({ from, to, timestamp: Date.now() });\n        }\n    }\n}\n\n/**\n * Creates a circuit breaker wrapper for CrossBus peer requests.\n * \n * @param {import(\"../core/cross-bus.js\").CrossBus} bus - CrossBus instance.\n * @param {string} peerId - Peer ID to protect.\n * @param {CircuitBreakerOptions} [options={}]\n * @returns {{ request: Function, breaker: CircuitBreaker }}\n * \n * @example\n * const { request, breaker } = createPeerCircuitBreaker(\n *   bus, \n *   'unstable-widget',\n *   { failureThreshold: 3 }\n * );\n * \n * try {\n *   const data = await request('getData', { id: 5 });\n * } catch (error) {\n *   if (breaker.isOpen) {\n *     console.log('Widget is unavailable');\n *   }\n * }\n */\nexport function createPeerCircuitBreaker(bus, peerId, options = {}) {\n    const breaker = new CircuitBreaker(options);\n\n    return {\n        breaker,\n\n        /**\n         * Request through circuit breaker.\n         * \n         * @param {string} handlerName - Handler to invoke.\n         * @param {*} [payload] - Request payload.\n         * @param {Object} [requestOptions] - Request options.\n         * @returns {Promise<*>}\n         */\n        request: (handlerName, payload, requestOptions = {}) => {\n            return breaker.execute(() =>\n                bus.request(peerId, handlerName, payload, requestOptions)\n            );\n        }\n    };\n}\n","/**\n * @fileoverview Centralized error handling for CrossBus.\n * @module common/errors\n */\n\n/**\n * Error codes for CrossBus.\n * @readonly\n * @enum {string}\n */\nexport const ErrorCode = Object.freeze({\n    // Connection errors\n    HANDSHAKE_TIMEOUT: 'ERR_HANDSHAKE_TIMEOUT',\n    HANDSHAKE_REJECTED: 'ERR_HANDSHAKE_REJECTED',\n    ORIGIN_FORBIDDEN: 'ERR_ORIGIN_FORBIDDEN',\n    PEER_EXISTS: 'ERR_PEER_EXISTS',\n    PEER_NOT_FOUND: 'ERR_PEER_NOT_FOUND',\n    PEER_DISCONNECTED: 'ERR_PEER_DISCONNECTED',\n    RECONNECT_FAILED: 'ERR_RECONNECT_FAILED',\n    UNSUPPORTED: 'ERR_UNSUPPORTED',\n    NOT_CONNECTED: 'ERR_NOT_CONNECTED',\n\n    // Message errors\n    ACK_TIMEOUT: 'ERR_ACK_TIMEOUT',\n    RESPONSE_TIMEOUT: 'ERR_RESPONSE_TIMEOUT',\n    QUEUE_FULL: 'ERR_QUEUE_FULL',\n    INVALID_MESSAGE: 'ERR_INVALID_MESSAGE',\n    VERSION_MISMATCH: 'ERR_VERSION_MISMATCH',\n    CLONE_ERROR: 'ERR_CLONE_ERROR',\n    TRANSFER_ERROR: 'ERR_TRANSFER_ERROR',\n    MESSAGE_TOO_LARGE: 'ERR_MESSAGE_TOO_LARGE',\n\n    // Routing errors\n    UNREACHABLE: 'ERR_UNREACHABLE',\n    TTL_EXCEEDED: 'ERR_TTL_EXCEEDED',\n    NO_ROUTE: 'ERR_NO_ROUTE',\n\n    // Handler errors\n    NO_HANDLER: 'ERR_NO_HANDLER',\n    HANDLER_ERROR: 'ERR_HANDLER_ERROR',\n    HANDLER_TIMEOUT: 'ERR_HANDLER_TIMEOUT',\n    HANDLER_EXISTS: 'ERR_HANDLER_EXISTS',\n    SEND_FAILED: 'ERR_SEND_FAILED',\n\n    // Channel errors\n    CHANNEL_FAILED: 'ERR_CHANNEL_FAILED',\n    CHANNEL_CLOSED: 'ERR_CHANNEL_CLOSED',\n\n    // Resource errors\n    MAX_PEERS: 'ERR_MAX_PEERS',\n    MAX_PENDING: 'ERR_MAX_PENDING',\n    DESTROYED: 'ERR_DESTROYED',\n\n    // Circuit Breaker\n    CIRCUIT_OPEN: 'ERR_CIRCUIT_OPEN',\n\n    // Security errors\n    PAYLOAD_TOO_LARGE: 'ERR_PAYLOAD_TOO_LARGE',\n    RATE_LIMITED: 'ERR_RATE_LIMITED',\n    UNAUTHORIZED: 'ERR_UNAUTHORIZED',\n    INVALID_PAYLOAD: 'ERR_INVALID_PAYLOAD'\n});\n\n/**\n * Error metadata including default messages, retryability, and AI-friendly suggestions.\n * @type {Object<ErrorCode, {message: string, retryable: boolean, suggestion: string}>}\n */\nconst ERROR_META = Object.freeze({\n    [ErrorCode.HANDSHAKE_TIMEOUT]: {\n        message: 'Handshake timed out',\n        retryable: true,\n        suggestion: 'Increase timeout or check if target is loaded. Use iframe.onload before connecting.'\n    },\n    [ErrorCode.HANDSHAKE_REJECTED]: {\n        message: 'Handshake rejected by peer',\n        retryable: false,\n        suggestion: 'Check targetOrigin matches the peer\\'s origin. Verify peer allows your origin.'\n    },\n    [ErrorCode.ORIGIN_FORBIDDEN]: {\n        message: 'Origin not in allowed origins list',\n        retryable: false,\n        suggestion: 'Add your origin to allowedOrigins option or use targetOrigin: \"*\" for development.'\n    },\n    [ErrorCode.PEER_EXISTS]: {\n        message: 'Peer with this ID already exists',\n        retryable: false,\n        suggestion: 'Use unique peerId for each context. Try: peerId: `agent-${Date.now()}`'\n    },\n    [ErrorCode.PEER_NOT_FOUND]: {\n        message: 'Peer not found',\n        retryable: false,\n        suggestion: 'Check if peer is connected using bus.peers. Wait for peer connection before request.'\n    },\n    [ErrorCode.PEER_DISCONNECTED]: {\n        message: 'Peer is disconnected',\n        retryable: true,\n        suggestion: 'Wait for peer to reconnect. Listen for \"peer:join\" event before retry.'\n    },\n    [ErrorCode.RECONNECT_FAILED]: {\n        message: 'Max reconnection attempts reached',\n        retryable: false,\n        suggestion: 'Check network connectivity. Consider increasing maxRetries option.'\n    },\n    [ErrorCode.UNSUPPORTED]: {\n        message: 'Operation not supported by this environment',\n        retryable: false,\n        suggestion: 'This feature requires a browser environment. Check for feature availability first.'\n    },\n    [ErrorCode.NOT_CONNECTED]: {\n        message: 'Transport is not connected',\n        retryable: true,\n        suggestion: 'Call addTransport() and wait for connection before sending messages.'\n    },\n    [ErrorCode.ACK_TIMEOUT]: {\n        message: 'ACK not received within timeout',\n        retryable: true,\n        suggestion: 'Increase ackTimeout option or check peer availability.'\n    },\n    [ErrorCode.RESPONSE_TIMEOUT]: {\n        message: 'Response not received within timeout',\n        retryable: true,\n        suggestion: 'Increase timeout in request options: { timeout: 10000 }. Check if handler exists on peer.'\n    },\n    [ErrorCode.QUEUE_FULL]: {\n        message: 'Message queue is full',\n        retryable: false,\n        suggestion: 'Increase maxQueueSize or wait for queue to drain. Consider using batching plugin.'\n    },\n    [ErrorCode.INVALID_MESSAGE]: {\n        message: 'Invalid message format',\n        retryable: false,\n        suggestion: 'Ensure message data is JSON-serializable. Avoid DOM nodes and functions.'\n    },\n    [ErrorCode.VERSION_MISMATCH]: {\n        message: 'Protocol version mismatch',\n        retryable: false,\n        suggestion: 'Update CrossBus to same version on both sides.'\n    },\n    [ErrorCode.CLONE_ERROR]: {\n        message: 'Data cannot be cloned (contains functions or DOM nodes)',\n        retryable: false,\n        suggestion: 'Remove functions, DOM nodes, and circular references from message data.'\n    },\n    [ErrorCode.TRANSFER_ERROR]: {\n        message: 'Failed to transfer object ownership',\n        retryable: false,\n        suggestion: 'Ensure ArrayBuffers are not detached. Each buffer can only be transferred once.'\n    },\n    [ErrorCode.MESSAGE_TOO_LARGE]: {\n        message: 'Message exceeds maximum size',\n        retryable: false,\n        suggestion: 'Use streaming for large payloads or increase maxMessageSize option.'\n    },\n    [ErrorCode.UNREACHABLE]: {\n        message: 'Destination peer is unreachable',\n        retryable: true,\n        suggestion: 'Check if peer is still connected. Use bus.peers to list available peers.'\n    },\n    [ErrorCode.TTL_EXCEEDED]: {\n        message: 'Message TTL exceeded (possible routing loop)',\n        retryable: false,\n        suggestion: 'Check for circular transport configurations. Increase maxTTL if needed.'\n    },\n    [ErrorCode.NO_ROUTE]: {\n        message: 'No route to destination',\n        retryable: false,\n        suggestion: 'Add transport connecting to target peer. Set isHub: true on orchestrator.'\n    },\n    [ErrorCode.NO_HANDLER]: {\n        message: 'No handler registered for this request',\n        retryable: false,\n        suggestion: 'Register handler on target: bus.handle(\"handlerName\", fn). Check handler name spelling.'\n    },\n    [ErrorCode.HANDLER_ERROR]: {\n        message: 'Handler threw an exception',\n        retryable: false,\n        suggestion: 'Check target peer logs for error. Wrap handler in try/catch.'\n    },\n    [ErrorCode.HANDLER_TIMEOUT]: {\n        message: 'Handler did not respond within timeout',\n        retryable: true,\n        suggestion: 'Handler is slow. Increase timeout or optimize handler performance.'\n    },\n    [ErrorCode.HANDLER_EXISTS]: {\n        message: 'Handler already registered with this name',\n        retryable: false,\n        suggestion: 'Use different handler name or call bus.removeHandler() first.'\n    },\n    [ErrorCode.SEND_FAILED]: {\n        message: 'Failed to send message to peer',\n        retryable: true,\n        suggestion: 'Check transport status. Target window may be closed or blocked.'\n    },\n    [ErrorCode.CHANNEL_FAILED]: {\n        message: 'Failed to create direct channel',\n        retryable: true,\n        suggestion: 'Check browser support for MessageChannel. Retry after short delay.'\n    },\n    [ErrorCode.CHANNEL_CLOSED]: {\n        message: 'Channel was closed unexpectedly',\n        retryable: false,\n        suggestion: 'Target context was destroyed. Check if iframe/worker still exists.'\n    },\n    [ErrorCode.MAX_PEERS]: {\n        message: 'Maximum number of peers reached',\n        retryable: false,\n        suggestion: 'Increase maxPeers option or disconnect unused peers first.'\n    },\n    [ErrorCode.MAX_PENDING]: {\n        message: 'Maximum pending requests reached',\n        retryable: false,\n        suggestion: 'Wait for pending requests to complete. Increase maxPendingRequests option.'\n    },\n    [ErrorCode.DESTROYED]: {\n        message: 'CrossBus instance has been destroyed',\n        retryable: false,\n        suggestion: 'Create new CrossBus instance. Do not use bus after calling destroy().'\n    },\n    [ErrorCode.CIRCUIT_OPEN]: {\n        message: 'Circuit breaker is open',\n        retryable: false,\n        suggestion: 'Too many failures. Wait for circuit to reset or call circuit.reset().'\n    },\n    [ErrorCode.PAYLOAD_TOO_LARGE]: {\n        message: 'Payload exceeds maximum allowed size',\n        retryable: false,\n        suggestion: 'Reduce payload size or increase maxPayloadSize option. Consider using streaming for large data.'\n    },\n    [ErrorCode.RATE_LIMITED]: {\n        message: 'Request rate limit exceeded',\n        retryable: true,\n        suggestion: 'Wait before retrying. Consider adding delay or using exponential backoff.'\n    },\n    [ErrorCode.UNAUTHORIZED]: {\n        message: 'Peer is not authorized to call this handler',\n        retryable: false,\n        suggestion: 'Add peer to handler allowedPeers list or remove peer restrictions.'\n    },\n    [ErrorCode.INVALID_PAYLOAD]: {\n        message: 'Payload validation failed',\n        retryable: false,\n        suggestion: 'Check payload structure against handler requirements.'\n    }\n});\n\n/**\n * Custom error class for CrossBus.\n * \n * @extends Error\n * \n * @example\n * try {\n *   await bus.emit('msg', data, 'unknown-peer');\n * } catch (err) {\n *   if (err instanceof CrossBusError) {\n *     console.log(err.code);      // 'ERR_PEER_NOT_FOUND'\n *     console.log(err.message);   // 'Peer not found'\n *     console.log(err.details);   // { peerId: 'unknown-peer' }\n *     console.log(err.retryable); // false\n *   }\n * }\n */\nexport class CrossBusError extends Error {\n    /**\n     * Error code.\n     * @type {ErrorCode}\n     */\n    code;\n\n    /**\n     * Additional error context.\n     * @type {Object}\n     */\n    details;\n\n    /**\n     * Whether the operation can be retried.\n     * @type {boolean}\n     */\n    retryable;\n\n    /**\n     * Original error that caused this error.\n     * @type {Error|undefined}\n     */\n    cause;\n\n    /**\n     * Timestamp when error occurred.\n     * @type {number}\n     */\n    timestamp;\n\n    /**\n     * Creates a new CrossBusError.\n     * \n     * @param {ErrorCode} code - Error code.\n     * @param {string} [message] - Custom message (uses default if omitted).\n     * @param {Object} [options] - Additional options.\n     * @param {Object} [options.details={}] - Error context.\n     * @param {boolean} [options.retryable] - Override default retryable.\n     * @param {Error} [options.cause] - Original error.\n     */\n    constructor(code, message, options = {}) {\n        const meta = ERROR_META[code] ?? { message: 'Unknown error', retryable: false };\n        super(message ?? meta.message);\n\n        this.name = 'CrossBusError';\n        this.code = code;\n        this.details = options.details ?? {};\n        this.retryable = options.retryable ?? meta.retryable;\n        this.cause = options.cause;\n        this.timestamp = Date.now();\n\n        // Maintain proper stack trace in V8\n        if (Error.captureStackTrace) {\n            Error.captureStackTrace(this, CrossBusError);\n        }\n    }\n\n    /**\n     * Creates error from code with default message.\n     * \n     * @param {ErrorCode} code - Error code.\n     * @param {Object} [details] - Error context.\n     * @returns {CrossBusError}\n     */\n    static from(code, details = {}) {\n        return new CrossBusError(code, undefined, { details });\n    }\n\n    /**\n     * Creates error from another error.\n     * \n     * @param {ErrorCode} code - Error code.\n     * @param {Error} cause - Original error.\n     * @param {Object} [details] - Additional context.\n     * @returns {CrossBusError}\n     */\n    static wrap(code, cause, details = {}) {\n        return new CrossBusError(code, cause.message, { cause, details });\n    }\n\n    /**\n     * Converts error to JSON-serializable object.\n     * @returns {Object}\n     */\n    toJSON() {\n        return {\n            name: this.name,\n            code: this.code,\n            message: this.message,\n            details: this.details,\n            retryable: this.retryable,\n            timestamp: this.timestamp\n        };\n    }\n\n    /**\n     * String representation.\n     * @returns {string}\n     */\n    toString() {\n        return `${this.name} [${this.code}]: ${this.message}`;\n    }\n}\n\n/**\n * Checks if an error is a CrossBusError.\n * \n * @param {*} err - Value to check.\n * @returns {boolean}\n */\nexport function isCrossBusError(err) {\n    return err instanceof CrossBusError;\n}\n\n/**\n * Checks if an error is retryable.\n * \n * @param {Error} err - Error to check.\n * @returns {boolean}\n */\nexport function isRetryable(err) {\n    if (err instanceof CrossBusError) {\n        return err.retryable;\n    }\n    return false;\n}\n"],"names":["createPeerCircuitBreaker","bus","peerId","options","breaker","CircuitBreaker","handlerName","payload","requestOptions","execute","request","ErrorCode","Object","freeze","HANDSHAKE_TIMEOUT","HANDSHAKE_REJECTED","ORIGIN_FORBIDDEN","PEER_EXISTS","PEER_NOT_FOUND","PEER_DISCONNECTED","RECONNECT_FAILED","UNSUPPORTED","NOT_CONNECTED","ACK_TIMEOUT","RESPONSE_TIMEOUT","QUEUE_FULL","INVALID_MESSAGE","VERSION_MISMATCH","CLONE_ERROR","TRANSFER_ERROR","MESSAGE_TOO_LARGE","UNREACHABLE","TTL_EXCEEDED","NO_ROUTE","NO_HANDLER","HANDLER_ERROR","HANDLER_TIMEOUT","HANDLER_EXISTS","SEND_FAILED","CHANNEL_FAILED","CHANNEL_CLOSED","MAX_PEERS","MAX_PENDING","DESTROYED","CIRCUIT_OPEN","PAYLOAD_TOO_LARGE","RATE_LIMITED","UNAUTHORIZED","INVALID_PAYLOAD","ERROR_META","message","retryable","suggestion","CrossBusError","Error","code","details","cause","timestamp","constructor","meta","super","this","name","Date","now","captureStackTrace","from","undefined","wrap","toJSON","toString","CircuitState","CLOSED","OPEN","HALF_OPEN","DEFAULT_CIRCUIT_OPTIONS","failureThreshold","successThreshold","resetTimeout","onStateChange","state","failures","successes","lastFailureTime","openedAt","totalRequests","totalFailures","totalSuccesses","checkHalfOpen","stats","isOpen","isClosed","fn","result","onSuccess","error","isFailure","onFailure","reset","previousState","notifyStateChange","trip","to"],"mappings":"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"}