function t(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const s=16*Math.random()|0;return("x"===t?s:3&s|8).toString(16)})}function s(t){return{outbound(s,e){const r=t.startSpan(`${e.type}:${e.handlerName||"signal"}`,{attributes:{"crossbus.type":e.type,"crossbus.direction":"outbound","crossbus.peer":e.peerId}}),i={...s,t:r.toTraceparent()};return r.end(),i},inbound(s,e){if(s&&s.t){const r=t.startSpanFromTraceparent(`${e.type}:${e.handlerName||"signal"}`,s.t);r.setAttributes({"crossbus.type":e.type,"crossbus.direction":"inbound","crossbus.peer":e.peerId}),r.end();const{t:i,...n}=s;return n}return s}}}class e{#t;#s;#e;#r=null;#i="unset";#n=null;#h=[];#o={};#u;constructor(t,s,e){this.#u=t,this.#s=s,this.#t=e,this.#e=Date.now()}get context(){return this.#t}get name(){return this.#s}get isEnded(){return null!==this.#r}setAttribute(t,s){return this.isEnded||(this.#o[t]=s),this}setAttributes(t){return this.isEnded||Object.assign(this.#o,t),this}addEvent(t,s){return this.isEnded||this.#h.push({name:t,timestamp:Date.now(),attributes:s}),this}setStatus(t,s){return this.isEnded||(this.#i=t,this.#n=s??null),this}recordException(t){return this.addEvent("exception",{"exception.type":t.name,"exception.message":t.message,"exception.stacktrace":t.stack}),this.setStatus("error",t.message),this}end(){this.isEnded||(this.#r=Date.now(),this.#u.i(this))}toTraceparent(){const t=this.#t.traceFlags.toString(16).padStart(2,"0");return`00-${this.#t.traceId}-${this.#t.spanId}-${t}`}toJSON(){return{traceId:this.#t.traceId,spanId:this.#t.spanId,parentSpanId:this.#t.parentSpanId,name:this.#s,startTime:this.#e,endTime:this.#r,duration:this.#r?this.#r-this.#e:null,status:this.#i,statusMessage:this.#n,attributes:{...this.#o},events:[...this.#h]}}}class r{#c;#a=new Map;#p=[];#d;#l;#f=[];constructor(t="crossbus",s={}){this.#c=t,this.#d=s.maxSpans??1e3,this.#l=s.sampled??!0}startSpan(t,s={}){const r=s.parent,i={traceId:r?.context.traceId??this.#g(),spanId:this.#m(),parentSpanId:r?.context.spanId,traceFlags:this.#l?1:0},n=new e(this,t,i);s.attributes&&n.setAttributes(s.attributes),this.#a.has(i.traceId)||this.#a.set(i.traceId,[]);const h=this.#a.get(i.traceId);return h&&h.push(n),n}startSpanFromTraceparent(t,s){const r=this.parseTraceparent(s);if(!r)return this.startSpan(t);const i=new e(this,t,{traceId:r.traceId,spanId:this.#m(),parentSpanId:r.spanId,traceFlags:r.traceFlags});this.#a.has(r.traceId)||this.#a.set(r.traceId,[]);const n=this.#a.get(r.traceId);return n&&n.push(i),i}parseTraceparent(t){if(!t||"string"!=typeof t)return null;const s=t.split("-");if(4!==s.length)return null;const[e,r,i,n]=s;return"00"!==e||32!==r.length||16!==i.length?null:{traceId:r,spanId:i,traceFlags:parseInt(n,16)}}getTrace(t){return this.#a.get(t)??[]}getCompletedSpans(){return[...this.#p]}exportTraces(t={}){const s=t.traceId?this.getTrace(t.traceId):this.#p;return{serviceName:this.#c,exportedAt:(new Date).toISOString(),spanCount:s.length,spans:s.map(t=>t.toJSON())}}clear(){this.#a.clear(),this.#p=[]}onSpanEnd(t){return this.#f.push(t),()=>{const s=this.#f.indexOf(t);-1!==s&&this.#f.splice(s,1)}}i(t){this.#p.push(t),this.#p.length>this.#d&&this.#p.shift();for(const s of this.#f)try{s(t)}catch(t){}}#g(){return t().replace(/-/g,"")}#m(){return t().replace(/-/g,"").slice(0,16)}}const i=new r("crossbus");class n{#x;#b;#$=0;#y=0;constructor(t=[.001,.005,.01,.025,.05,.1,.25,.5,1,2.5,5,10]){this.#x=[...t].sort((t,s)=>t-s),this.#b=new Array(this.#x.length+1).fill(0)}observe(t){this.#$+=t,this.#y++;for(let s=0;s<this.#x.length;s++)if(t<=this.#x[s])return void this.#b[s]++;this.#b[this.#b.length-1]++}getData(){const t=this.#x.map((t,s)=>({le:t,count:this.#b[s]}));return t.push({le:1/0,count:this.#b[this.#b.length-1]}),{buckets:t,sum:this.#$,count:this.#y}}percentile(t){if(0===this.#y)return 0;const s=t*this.#y;let e=0;for(let t=0;t<this.#b.length;t++)if(e+=this.#b[t],e>=s)return t<this.#x.length?this.#x[t]:1/0;return 1/0}reset(){this.#b.fill(0),this.#$=0,this.#y=0}}class h{#w=new Map;#S=new Map;#v=new Map;#_=[];#I;#M=new Map;constructor(t={}){this.#I=t.prefix??"crossbus",this.#S.set("latency",new n)}increment(t,s=1,e={}){const r=this.#k(t,e),i=this.#w.get(r)??0;this.#w.set(r,i+s),this.#q({name:`${this.#I}_${t}`,type:"counter",value:i+s,labels:e,timestamp:Date.now()})}getCounter(t,s={}){return this.#w.get(this.#k(t,s))??0}observe(t,s,e={}){const r=this.#k(t,e);this.#S.has(r)||this.#S.set(r,new n);const i=this.#S.get(r);i&&i.observe(s),this.#q({name:`${this.#I}_${t}`,type:"histogram",value:s,labels:e,timestamp:Date.now()})}getHistogram(t,s={}){const e=this.#S.get(this.#k(t,s));return e?.getData()??{buckets:[],sum:0,count:0}}set(t,s,e={}){const r=this.#k(t,e);this.#v.set(r,s),this.#q({name:`${this.#I}_${t}`,type:"gauge",value:s,labels:e,timestamp:Date.now()})}getGauge(t,s={}){return this.#v.get(this.#k(t,s))??0}on(t,s){return"metric"===t?(this.#_.push(s),()=>{const t=this.#_.indexOf(s);-1!==t&&this.#_.splice(t,1)}):()=>{}}get outboundHook(){return(t,s)=>(this.increment("messages_sent_total",1,{type:s.type}),"request"===s.type&&t?.id&&this.#M.set(t.id,Date.now()),t)}get inboundHook(){return(t,s)=>{if(this.increment("messages_received_total",1,{type:s.type}),"response"===s.type&&t?.requestId){const s=this.#M.get(t.requestId);if(s){const e=Date.now()-s;this.observe("latency_seconds",e/1e3),this.#M.delete(t.requestId)}}return t}}toPrometheus(){const t=[];for(const[s,e]of this.#w)t.push(`${this.#I}_${s} ${e}`);for(const[s,e]of this.#v)t.push(`${this.#I}_${s} ${e}`);for(const[s,e]of this.#S){const r=e.getData();for(const e of r.buckets)t.push(`${this.#I}_${s}_bucket{le="${e.le===1/0?"+Inf":e.le}"} ${e.count}`);t.push(`${this.#I}_${s}_sum ${r.sum}`),t.push(`${this.#I}_${s}_count ${r.count}`)}return t.join("\n")}toJSON(){const t={};for(const[s,e]of this.#w)t[s]=e;const s={};for(const[t,e]of this.#v)s[t]=e;const e={};for(const[t,s]of this.#S)e[t]=s.getData();return{exportedAt:(new Date).toISOString(),prefix:this.#I,counters:t,gauges:s,histograms:e}}reset(){this.#w.clear(),this.#v.clear();for(const t of this.#S.values())t.reset();this.#M.clear()}#k(t,s){return 0===Object.keys(s).length?t:`${t}{${Object.entries(s).sort(([t],[s])=>t.localeCompare(s)).map(([t,s])=>`${t}="${s}"`).join(",")}}`}#q(t){for(const s of this.#_)try{s(t)}catch(t){}}}const o=new h;class u{#D=[];#T;#A;#E=0;#j=0;#z=!1;#C=null;constructor(t,s){this.#T=s.maxSize,this.#A=s.strategy}setSendFn(t){this.#C=t}enqueue(t){if(!this.#z&&0===this.#D.length&&this.#C)try{return this.#C(t),this.#j++,{success:!0,queued:!1,dropped:!1}}catch{}return this.#D.length>=this.#T?this.#F(t):(this.#D.push(t),{success:!0,queued:!0,dropped:!1})}#F(t){switch(this.#A){case"drop-oldest":return this.#D.shift(),this.#D.push(t),this.#E++,{success:!0,queued:!0,dropped:!0};case"drop-newest":return this.#E++,{success:!1,queued:!1,dropped:!0};case"reject":default:return{success:!1,queued:!1,dropped:!1};case"pause":return this.#z=!0,{success:!1,queued:!1,dropped:!1}}}flush(t){if(!this.#C)return 0;const s=t??this.#D.length;let e=0;for(let t=0;t<s&&this.#D.length>0;t++){const t=this.#D.shift();try{this.#C(t),e++,this.#j++}catch{this.#D.unshift(t);break}}return e}resume(){this.#z=!1,this.flush()}pause(){this.#z=!0}clear(){this.#D=[]}getStats(){return{size:this.#D.length,maxSize:this.#T,dropped:this.#E,processed:this.#j,isPaused:this.#z}}}class c{#N=new Map;#O;#H;#V=[];#B;#J=null;constructor(t={}){this.#O=t.maxQueueSize??100,this.#H=t.strategy??"drop-oldest",this.#B=t.checkIntervalMs??1e3}wrap(t,s,e={}){const r=new u(t,{maxSize:e.maxQueueSize??this.#O,strategy:e.strategy??this.#H});return r.setSendFn(s),this.#N.set(t,r),this.#P(),t=>r.enqueue(t)}configure(t,s){let e=this.#N.get(t);e||(e=new u(t,{maxSize:s.maxQueueSize??this.#O,strategy:s.strategy??this.#H}),this.#N.set(t,e))}flush(t,s){return this.#N.get(t)?.flush(s)??0}flushAll(){let t=0;for(const s of this.#N.values())t+=s.flush();return t}pause(t){this.#N.get(t)?.pause()}resume(t){this.#N.get(t)?.resume()}getStats(t){return this.#N.get(t)?.getStats()??null}getAllStats(){const t={};for(const[s,e]of this.#N)t[s]=e.getStats();return t}onBackpressure(t){return this.#V.push(t),()=>{const s=this.#V.indexOf(t);-1!==s&&this.#V.splice(s,1)}}remove(t){const s=this.#N.get(t);s&&(s.clear(),this.#N.delete(t))}destroy(){this.#J&&(clearInterval(this.#J),this.#J=null);for(const t of this.#N.values())t.clear();this.#N.clear(),this.#V=[]}#P(){this.#J||(this.#J=setInterval(()=>{for(const[t,s]of this.#N){const e=s.getStats();if(e.size>.5*e.maxSize||e.isPaused)for(const s of this.#V)try{s(t,e)}catch(t){}}},this.#B))}}class a{#G=new Map;#K=new Map;#L;constructor(t={}){this.#L=t.defaultVersion??1}registerMigration(t,s,e,r){this.#G.has(t)||this.#G.set(t,new Map);const i=this.#G.get(t);i&&i.set(`${s}:${e}`,r)}setCurrentVersion(t,s){this.#K.set(t,s)}getCurrentVersion(t){return this.#K.get(t)??this.#L}migrate(t,s,e,r){if(e===r)return s;const i=this.#G.get(t);if(!i)throw new Error(`No migrations registered for type: ${t}`);let n=s,h=e;for(;h!==r;){const s=h<r?h+1:h-1,e=i.get(`${h}:${s}`);if(!e)throw new Error(`No migration path from v${h} to v${s} for type: ${t}`);n=e(n),h=s}return n}needsMigration(t,s){return s!==this.getCurrentVersion(t)}createMessage(t,s,e){return{h:e??this.getCurrentVersion(t),...s}}getVersion(t){return t?.h??this.#L}createInboundHook(){return(t,s)=>{if(!t||"object"!=typeof t)return t;const e=this.getVersion(t),r=s.handlerName||s.type,i=this.getCurrentVersion(r);if(e!==i&&this.#G.has(r))try{const{h:s,...n}=t;return{h:i,...this.migrate(r,n,e,i)}}catch(s){return t}return t}}createOutboundHook(){return(t,s)=>t&&"object"==typeof t?void 0!==t.h?t:{h:this.getCurrentVersion(s.handlerName||s.type),...t}:t}getMigrations(){const t={};for(const[s,e]of this.#G)t[s]=Array.from(e.keys());return t}clear(){this.#G.clear(),this.#K.clear()}}const p=new a;export{c as BackpressureController,a as MessageVersioning,h as Metrics,e as Span,r as Tracer,o as globalMetrics,i as globalTracer,p as globalVersioning,s as tracingPlugin};
//# sourceMappingURL=enterprise.min.js.map
