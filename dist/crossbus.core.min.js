function e(e,t,s={},r=null){return Object.freeze({[d]:1,version:1,id:r||crypto.randomUUID(),type:e,timestamp:Date.now(),payload:Object.freeze({...t}),meta:Object.freeze({...s})})}function t(t,s,r,i=!0,n=null){return e(l.RESPONSE,{requestId:t,data:s,source:r,success:i,error:n})}function s(){return"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function r(){if("function"==typeof Promise.withResolvers)return Promise.withResolvers();let e,t;return{promise:new Promise((s,r)=>{e=s,t=r}),resolve:e,reject:t}}function i(e,t,s="Operation timed out"){return Promise.race([e,new Promise((e,r)=>{setTimeout(()=>r(new Error(s)),t)})])}const n=Symbol("listeners"),o=Symbol("subCounter"),a=Symbol("maxListeners"),h=Symbol("fastCache"),c=Object.freeze({peerId:"self",origin:void 0!==globalThis.location?globalThis.location.origin:"unknown",type:"local"});class u{constructor(){this[n]=new Map,this[o]=0,this[a]=10,this[h]=Object.create(null)}setMaxListeners(e){return this[a]=e,this}getMaxListeners(){return this[a]}on(e,t,s={}){if("string"!=typeof e)throw new TypeError("Signal name must be a string");if("function"!=typeof t)throw new TypeError("Handler must be a function");const r="sub_"+ ++this[o],i={id:r,handler:t,priority:s.priority??0,mode:s.mode??"async",once:s.once??!1,signal:s.signal??null};this[n].has(e)||this[n].set(e,[]);const a=this[n].get(e);if(0===a.length||i.priority<=a[a.length-1].priority)a.push(i);else{let e=0,t=a.length;for(;e<t;){const s=e+t>>>1;a[s].priority>=i.priority?e=s+1:t=s}a.splice(e,0,i)}this[h][e]=a.map(e=>e.handler);let c=!0;const u={id:r,signalName:e,get active(){return c},unsubscribe:()=>{c&&(this.#e(e,r),c=!1)}};return i.signal&&(i.signal.aborted?(this.#e(e,r),c=!1):i.signal.addEventListener("abort",()=>{u.unsubscribe()},{once:!0})),u}once(e,t,s={}){return this.on(e,t,{...s,once:!0})}onFast(e,t){return(this[h][e]||=[]).push(t),()=>{this[h][e]=this[h][e]?.filter(e=>e!==t)}}offFast(e,t){const s=this[h][e];if(s){const e=s.indexOf(t);-1!==e&&s.splice(e,1)}const r=this[n].get(e);if(r){const e=r.findIndex(e=>e.handler===t);-1!==e&&r.splice(e,1)}}off(e,t){if("string"!=typeof e)throw new TypeError("Signal name must be a string");const s=this[n].get(e);if(!s||0===s.length)return{success:!1,removedCount:0,remainingCount:0};let r=0;if(void 0===t)r=s.length,this[n].delete(e),delete this[h][e];else{const i=s.length,o=s.filter(e=>e.handler!==t);r=i-o.length,0===o.length?(this[n].delete(e),delete this[h][e]):(this[n].set(e,o),this[h][e]=o.map(e=>e.handler))}return{success:r>0,removedCount:r,remainingCount:this[n].get(e)?.length??0}}emitSync(e,t){const s=this[h][e];if(!s)return 0;const r=s.length;if(1===r)return s[0](t),1;if(2===r)return s[0](t),s[1](t),2;if(3===r)return s[0](t),s[1](t),s[2](t),3;if(4===r)return s[0](t),s[1](t),s[2](t),s[3](t),4;for(let e=0;e<r;e++)s[e](t);return r}async emit(e,t,s){if("string"!=typeof e)throw new TypeError("Signal name must be a string");const r=this[n].get(e),i=this[n].has("*");if(1===r?.length&&!i&&!s){const s=r[0],i={name:e,data:t,messageId:crypto.randomUUID(),timestamp:Date.now(),source:c};try{"sync"===s.mode?await s.handler(i):Promise.resolve().then(()=>s.handler(i))}catch(e){}return s.once&&this.#e(e,s.id),1}const o={name:e,data:t,messageId:crypto.randomUUID(),timestamp:Date.now(),source:s?{...c,...s}:c},a=this.#t(e),h=[];for(const{signalName:e,entry:t}of a){try{"sync"===t.mode?await t.handler(o):Promise.resolve().then(()=>t.handler(o))}catch(e){}t.once&&h.push({signalName:e,id:t.id})}for(const{signalName:e,id:t}of h)this.#e(e,t);return a.length}hasListeners(e){const t=this[n].get(e);return void 0!==t&&t.length>0}listenerCount(e){return this[n].get(e)?.length??0}getSignalNames(){return Array.from(this[n].keys())}clear(){this[n].clear();for(const e in this[h])delete this[h][e]}#t(e){const t=this[n].get(e),s=this[n].get("*");let r=null;const i=e.indexOf(":");if(i>0){const t=e.slice(0,i+1)+"*";r=this[n].get(t)}if(t&&!s&&!r)return t.map(t=>({signalName:e,entry:t}));const o=[t&&{signalName:e,entries:t},s&&{signalName:"*",entries:s},r&&{signalName:e.slice(0,i+1)+"*",entries:r}].filter(Boolean);if(0===o.length)return[];if(1===o.length)return o[0].entries.map(e=>({signalName:o[0].signalName,entry:e}));const a=[];for(const{signalName:e,entries:t}of o)for(const s of t)a.push({signalName:e,entry:s});return a.sort((e,t)=>t.entry.priority-e.entry.priority),a}#e(e,t){const s=this[n].get(e);if(!s)return;const r=s.filter(e=>e.id!==t);0===r.length?(this[n].delete(e),delete this[h][e]):(this[n].set(e,r),this[h][e]=r.map(e=>e.handler))}}const d="_cb",l=Object.freeze({SIGNAL:"sig",REQUEST:"req",RESPONSE:"res",ACK:"ack",HANDSHAKE:"hsk",HANDSHAKE_INIT:"hsk_init",HANDSHAKE_ACK:"hsk_ack",HANDSHAKE_COMPLETE:"hsk_done",PING:"png",PONG:"pog",BYE:"bye",BROADCAST:"bc"}),g=Object.freeze({INIT:"init",INIT_SENT:"init_sent",ACK:"ack",ACK_SENT:"ack_sent",DONE:"done"}),p=Object.freeze({CONNECTING:"connecting",CONNECTED:"connected",DISCONNECTED:"disconnected",RECONNECTING:"reconnecting",FAILED:"failed"}),f=Object.freeze({HANDSHAKE_TIMEOUT:"ERR_HANDSHAKE_TIMEOUT",HANDSHAKE_REJECTED:"ERR_HANDSHAKE_REJECTED",ORIGIN_FORBIDDEN:"ERR_ORIGIN_FORBIDDEN",PEER_EXISTS:"ERR_PEER_EXISTS",PEER_NOT_FOUND:"ERR_PEER_NOT_FOUND",PEER_DISCONNECTED:"ERR_PEER_DISCONNECTED",RECONNECT_FAILED:"ERR_RECONNECT_FAILED",UNSUPPORTED:"ERR_UNSUPPORTED",NOT_CONNECTED:"ERR_NOT_CONNECTED",ACK_TIMEOUT:"ERR_ACK_TIMEOUT",RESPONSE_TIMEOUT:"ERR_RESPONSE_TIMEOUT",QUEUE_FULL:"ERR_QUEUE_FULL",INVALID_MESSAGE:"ERR_INVALID_MESSAGE",VERSION_MISMATCH:"ERR_VERSION_MISMATCH",CLONE_ERROR:"ERR_CLONE_ERROR",TRANSFER_ERROR:"ERR_TRANSFER_ERROR",MESSAGE_TOO_LARGE:"ERR_MESSAGE_TOO_LARGE",UNREACHABLE:"ERR_UNREACHABLE",TTL_EXCEEDED:"ERR_TTL_EXCEEDED",NO_ROUTE:"ERR_NO_ROUTE",NO_HANDLER:"ERR_NO_HANDLER",HANDLER_ERROR:"ERR_HANDLER_ERROR",HANDLER_TIMEOUT:"ERR_HANDLER_TIMEOUT",HANDLER_EXISTS:"ERR_HANDLER_EXISTS",SEND_FAILED:"ERR_SEND_FAILED",CHANNEL_FAILED:"ERR_CHANNEL_FAILED",CHANNEL_CLOSED:"ERR_CHANNEL_CLOSED",MAX_PEERS:"ERR_MAX_PEERS",MAX_PENDING:"ERR_MAX_PENDING",DESTROYED:"ERR_DESTROYED",CIRCUIT_OPEN:"ERR_CIRCUIT_OPEN",PAYLOAD_TOO_LARGE:"ERR_PAYLOAD_TOO_LARGE",RATE_LIMITED:"ERR_RATE_LIMITED",UNAUTHORIZED:"ERR_UNAUTHORIZED",INVALID_PAYLOAD:"ERR_INVALID_PAYLOAD"}),m=Object.freeze({[f.HANDSHAKE_TIMEOUT]:{message:"Handshake timed out",retryable:!0,suggestion:"Increase timeout or check if target is loaded. Use iframe.onload before connecting."},[f.HANDSHAKE_REJECTED]:{message:"Handshake rejected by peer",retryable:!1,suggestion:"Check targetOrigin matches the peer's origin. Verify peer allows your origin."},[f.ORIGIN_FORBIDDEN]:{message:"Origin not in allowed origins list",retryable:!1,suggestion:'Add your origin to allowedOrigins option or use targetOrigin: "*" for development.'},[f.PEER_EXISTS]:{message:"Peer with this ID already exists",retryable:!1,suggestion:"Use unique peerId for each context. Try: peerId: `agent-${Date.now()}`"},[f.PEER_NOT_FOUND]:{message:"Peer not found",retryable:!1,suggestion:"Check if peer is connected using bus.peers. Wait for peer connection before request."},[f.PEER_DISCONNECTED]:{message:"Peer is disconnected",retryable:!0,suggestion:'Wait for peer to reconnect. Listen for "peer:join" event before retry.'},[f.RECONNECT_FAILED]:{message:"Max reconnection attempts reached",retryable:!1,suggestion:"Check network connectivity. Consider increasing maxRetries option."},[f.UNSUPPORTED]:{message:"Operation not supported by this environment",retryable:!1,suggestion:"This feature requires a browser environment. Check for feature availability first."},[f.NOT_CONNECTED]:{message:"Transport is not connected",retryable:!0,suggestion:"Call addTransport() and wait for connection before sending messages."},[f.ACK_TIMEOUT]:{message:"ACK not received within timeout",retryable:!0,suggestion:"Increase ackTimeout option or check peer availability."},[f.RESPONSE_TIMEOUT]:{message:"Response not received within timeout",retryable:!0,suggestion:"Increase timeout in request options: { timeout: 10000 }. Check if handler exists on peer."},[f.QUEUE_FULL]:{message:"Message queue is full",retryable:!1,suggestion:"Increase maxQueueSize or wait for queue to drain. Consider using batching plugin."},[f.INVALID_MESSAGE]:{message:"Invalid message format",retryable:!1,suggestion:"Ensure message data is JSON-serializable. Avoid DOM nodes and functions."},[f.VERSION_MISMATCH]:{message:"Protocol version mismatch",retryable:!1,suggestion:"Update CrossBus to same version on both sides."},[f.CLONE_ERROR]:{message:"Data cannot be cloned (contains functions or DOM nodes)",retryable:!1,suggestion:"Remove functions, DOM nodes, and circular references from message data."},[f.TRANSFER_ERROR]:{message:"Failed to transfer object ownership",retryable:!1,suggestion:"Ensure ArrayBuffers are not detached. Each buffer can only be transferred once."},[f.MESSAGE_TOO_LARGE]:{message:"Message exceeds maximum size",retryable:!1,suggestion:"Use streaming for large payloads or increase maxMessageSize option."},[f.UNREACHABLE]:{message:"Destination peer is unreachable",retryable:!0,suggestion:"Check if peer is still connected. Use bus.peers to list available peers."},[f.TTL_EXCEEDED]:{message:"Message TTL exceeded (possible routing loop)",retryable:!1,suggestion:"Check for circular transport configurations. Increase maxTTL if needed."},[f.NO_ROUTE]:{message:"No route to destination",retryable:!1,suggestion:"Add transport connecting to target peer. Set isHub: true on orchestrator."},[f.NO_HANDLER]:{message:"No handler registered for this request",retryable:!1,suggestion:'Register handler on target: bus.handle("handlerName", fn). Check handler name spelling.'},[f.HANDLER_ERROR]:{message:"Handler threw an exception",retryable:!1,suggestion:"Check target peer logs for error. Wrap handler in try/catch."},[f.HANDLER_TIMEOUT]:{message:"Handler did not respond within timeout",retryable:!0,suggestion:"Handler is slow. Increase timeout or optimize handler performance."},[f.HANDLER_EXISTS]:{message:"Handler already registered with this name",retryable:!1,suggestion:"Use different handler name or call bus.removeHandler() first."},[f.SEND_FAILED]:{message:"Failed to send message to peer",retryable:!0,suggestion:"Check transport status. Target window may be closed or blocked."},[f.CHANNEL_FAILED]:{message:"Failed to create direct channel",retryable:!0,suggestion:"Check browser support for MessageChannel. Retry after short delay."},[f.CHANNEL_CLOSED]:{message:"Channel was closed unexpectedly",retryable:!1,suggestion:"Target context was destroyed. Check if iframe/worker still exists."},[f.MAX_PEERS]:{message:"Maximum number of peers reached",retryable:!1,suggestion:"Increase maxPeers option or disconnect unused peers first."},[f.MAX_PENDING]:{message:"Maximum pending requests reached",retryable:!1,suggestion:"Wait for pending requests to complete. Increase maxPendingRequests option."},[f.DESTROYED]:{message:"CrossBus instance has been destroyed",retryable:!1,suggestion:"Create new CrossBus instance. Do not use bus after calling destroy()."},[f.CIRCUIT_OPEN]:{message:"Circuit breaker is open",retryable:!1,suggestion:"Too many failures. Wait for circuit to reset or call circuit.reset()."},[f.PAYLOAD_TOO_LARGE]:{message:"Payload exceeds maximum allowed size",retryable:!1,suggestion:"Reduce payload size or increase maxPayloadSize option. Consider using streaming for large data."},[f.RATE_LIMITED]:{message:"Request rate limit exceeded",retryable:!0,suggestion:"Wait before retrying. Consider adding delay or using exponential backoff."},[f.UNAUTHORIZED]:{message:"Peer is not authorized to call this handler",retryable:!1,suggestion:"Add peer to handler allowedPeers list or remove peer restrictions."},[f.INVALID_PAYLOAD]:{message:"Payload validation failed",retryable:!1,suggestion:"Check payload structure against handler requirements."}});class E extends Error{code;details;retryable;cause;timestamp;constructor(e,t,s={}){const r=m[e]??{message:"Unknown error",retryable:!1};super(t??r.message),this.name="CrossBusError",this.code=e,this.details=s.details??{},this.retryable=s.retryable??r.retryable,this.cause=s.cause,this.timestamp=Date.now(),Error.captureStackTrace&&Error.captureStackTrace(this,E)}static from(e,t={}){return new E(e,void 0,{details:t})}static wrap(e,t,s={}){return new E(e,t.message,{cause:t,details:s})}toJSON(){return{name:this.name,code:this.code,message:this.message,details:this.details,retryable:this.retryable,timestamp:this.timestamp}}toString(){return`${this.name} [${this.code}]: ${this.message}`}}class y extends u{#s=new Map;#r=0;#i=new Map;#n=Object.create(null);#o=Object.create(null);#a=[];constructor(){super()}addPeer(e,t,s={}){if(this.#s.has(e))throw E.from(f.PEER_EXISTS,{peerId:e});if("function"!=typeof t)throw new TypeError("sendFn must be a function");const r={peerId:e,sendFn:t,meta:s.meta??{},origin:s.origin??"unknown",status:p.CONNECTED,connectedAt:Date.now()};this.#s.set(e,r),this.#i.set(e,0),this.#n[e]=r,this.#o[e]=t,this.#a.push(e),this.emit("peer:added",{peerId:e,meta:r.meta})}removePeer(e){const t=this.#n[e];if(!t)return!1;this.#s.delete(e),this.#i.delete(e),delete this.#n[e],delete this.#o[e];const s=this.#a.indexOf(e);return-1!==s&&this.#a.splice(s,1),this.emit("peer:removed",{peerId:e,meta:t.meta}),!0}getPeer(e){return this.#n[e]}getPeerIds(){return this.#a.slice()}get peerCount(){return this.#s.size}route(e,t={}){const{target:s,payload:r}=e;if(s)return this.#h(s,r);{const e=t.exclude,s=e?.length?new Set(e):null;return this.#c(r,s)}}broadcast(e,t={}){const s=t.exclude,r=s?.length?new Set(s):null,i=t.include,n=i?.length?new Set(i):null;let o=0;const a=[];for(const[t,s]of this.#s)if(!r?.has(t)&&(!n||n.has(t))&&s.status===p.CONNECTED)try{const r=this.#u(t,e,l.BROADCAST);s.sendFn(r),o++}catch(e){a.push(t)}return{success:0===a.length,delivered:o,failed:a}}getSequence(e){return this.#i.get(e)??0}setPeerStatus(e,t){const s=this.#n[e];s&&(s.status=t,this.emit("peer:status",{peerId:e,status:t}))}clearPeers(){const e=this.#a.slice();for(const t of e)this.removePeer(t)}#h(e,t){const s=this.#n[e];if(!s)return{success:!1,delivered:0,failed:[e],error:f.PEER_NOT_FOUND};if(s.status!==p.CONNECTED)return{success:!1,delivered:0,failed:[e],error:f.PEER_DISCONNECTED};try{const r=t&&t.i?t:this.#u(e,t,l.SIGNAL);return s.sendFn(r),{success:!0,delivered:1,failed:[]}}catch(t){return{success:!1,delivered:0,failed:[e]}}}#c(e,t){return this.broadcast(e,t?{exclude:Array.from(t)}:{})}#u(e,t,s){const r=(this.#i.get(e)??0)+1;return this.#i.set(e,r),{id:"msg_"+ ++this.#r,t:s,ts:Date.now(),seq:r,p:t}}}class R{#d=new Map;#l=Object.create(null);#g=0;#p;#f;constructor(e={}){this.#p=e.defaultTimeout??3e4,this.#f=e.maxPending??1e3}create(e,t,s={}){if(this.#f>0&&this.#d.size>=this.#f)throw E.from(f.MAX_PENDING,{current:this.#d.size,max:this.#f,targetPeer:e,handlerName:t});const n=Date.now(),o=`req_${++this.#g}_${n}`,a=s.timeout??this.#p,{promise:h,resolve:c,reject:u}=r(),d={id:o,targetPeer:e,handlerName:t,createdAt:n,timeout:a,resolve:c,reject:u,defaultValue:s.defaultValue};this.#d.set(o,d),this.#l[o]=d;const l=i(h,a).catch(r=>{if(o in this.#l){if(this.#d.delete(o),delete this.#l[o],"defaultValue"in s)return s.defaultValue;throw E.from(f.RESPONSE_TIMEOUT,{requestId:o,targetPeer:e,handlerName:t,timeout:a})}throw r});return{requestId:o,promise:l}}resolve(e,t){const s=this.#l[e];if(!s)return!1;if(this.#d.delete(e),delete this.#l[e],t.success)s.resolve(t.data);else{const r=E.from(t.error?.code??f.HANDLER_ERROR,{requestId:e,targetPeer:s.targetPeer,handlerName:s.handlerName,originalError:t.error});r.message=t.error?.message??"Handler error",s.reject(r)}return!0}reject(e,t){const s=this.#l[e];if(!s)return!1;this.#d.delete(e),delete this.#l[e];const r=t instanceof Error?t:new Error(t);return s.reject(r),!0}cancel(e){const t=this.#l[e];return!!t&&(this.#d.delete(e),delete this.#l[e],t.reject(new Error("Request cancelled")),!0)}cancelForPeer(e){let t=0;for(const[s,r]of this.#d)r.targetPeer===e&&(this.#d.delete(s),delete this.#l[s],r.reject(E.from(f.PEER_DISCONNECTED,{peerId:e,requestId:s})),t++);return t}cancelAll(){const e=this.#d.size;for(const[e,t]of this.#d)t.reject(new Error("All requests cancelled"));this.#d.clear();for(const e in this.#l)delete this.#l[e];return e}has(e){return e in this.#l}get(e){return this.#l[e]}get size(){return this.#d.size}getRequestIds(){return Array.from(this.#d.keys())}getForPeer(e){const t=[];for(const s of this.#d.values())s.targetPeer===e&&t.push(s);return t}}class b{#m;#E;#y;#R;#b=new Map;constructor(e={}){this.#m=e.peerId??s(),this.#E=e.meta??{},this.#y=e.capabilities??[],this.#R=e.timeout??1e4}get peerId(){return this.#m}createInitMessage(){return{type:l.HANDSHAKE_INIT,handshakeId:s(),peerId:this.#m,meta:this.#E,capabilities:this.#y,timestamp:Date.now()}}createAckMessage(e,t,s){return{type:l.HANDSHAKE_ACK,handshakeId:e.handshakeId,peerId:this.#m,meta:this.#E,capabilities:this.#y,accept:t,reason:t?void 0:s,timestamp:Date.now()}}createCompleteMessage(e){return{type:l.HANDSHAKE_COMPLETE,handshakeId:e,confirmed:!0,timestamp:Date.now()}}async initiate(e){const t=this.createInitMessage(),{promise:s,resolve:n,reject:o}=r();this.#b.set(t.handshakeId,{phase:g.INIT_SENT,resolve:n,reject:o,initMsg:t,startTime:Date.now()}),e(t);try{return await i(s,this.#R)}catch(e){return this.#b.delete(t.handshakeId),e.code===f.HANDSHAKE_TIMEOUT?{success:!1,error:f.HANDSHAKE_TIMEOUT,reason:`Handshake timeout after ${this.#R}ms`}:{success:!1,error:f.HANDSHAKE_REJECTED,reason:e.message}}}handleMessage(e,t,s,r){switch(e.type){case l.HANDSHAKE_INIT:return this.#w(e,t,s,r);case l.HANDSHAKE_ACK:return this.#N(e,t,s);case l.HANDSHAKE_COMPLETE:return this.#I(e,t);default:return null}}hasPending(e){return this.#b.has(e)}cancel(e){const t=this.#b.get(e);t&&(t.reject(new Error("Handshake cancelled")),this.#b.delete(e))}cancelAll(){for(const[e,t]of this.#b)t.reject(new Error("All handshakes cancelled"));this.#b.clear()}#w(e,t,s,r){return r&&!r(e,t)?(s(this.createAckMessage(e,!1,"Validation failed")),null):(s(this.createAckMessage(e,!0)),this.#b.set(e.handshakeId,{phase:g.ACK_SENT,remotePeer:{peerId:e.peerId,origin:t,meta:e.meta,capabilities:e.capabilities}}),null)}#N(e,t,s){const r=this.#b.get(e.handshakeId);if(!r)return null;if(!e.accept)return r.reject(new Error(e.reason||"Connection rejected")),this.#b.delete(e.handshakeId),null;s(this.createCompleteMessage(e.handshakeId));const i={peerId:e.peerId,origin:t,meta:e.meta,capabilities:e.capabilities,type:"unknown",connectedAt:Date.now()};return r.resolve({success:!0,peer:i}),this.#b.delete(e.handshakeId),i}#I(e,t){const s=this.#b.get(e.handshakeId);if(!s||s.phase!==g.ACK_SENT)return null;if(!e.confirmed)return this.#b.delete(e.handshakeId),null;const r={...s.remotePeer,connectedAt:Date.now()};return this.#b.delete(e.handshakeId),r}}class w{#_=new Set;#A=[];#O=!1;#T;constructor(e={}){if(this.#O=e.allowAll??!1,this.#T=globalThis.location?.origin,e.allowed)for(const t of e.allowed)this.#C(t)}isAllowed(e){if(this.#O)return!0;if("null"===e||null===e)return this.#_.has("null");if(0===this.#_.size&&0===this.#A.length)return e===this.#T;if(this.#_.has(e))return!0;for(const t of this.#A)if(t.test(e))return!0;return!1}allow(e){return this.#C(e),this}disallow(e){return!!this.#_.has(e)&&(this.#_.delete(e),!0)}getAllowed(){return Array.from(this.#_)}clear(){this.#_.clear(),this.#A=[]}get selfOrigin(){return this.#T}#C(e){if("string"!=typeof e)throw new TypeError("Origin must be a string");if("*"!==e)if(e.includes("*")){const t=this.#D(e);this.#A.push(t)}else this.#_.add(e);else this.#O=!0}#D(e){const t=e.replace(/[.+?^${}()|[\]\\]/g,"\\$&").replace(/\*/g,"[a-zA-Z0-9.-]{0,253}");return new RegExp(`^${t}$`)}}class N extends u{#S;#x;#P;#H;#k;#L;#M;#v=new Map;#q=[];#U=[];#E;#y;#F;#j;#$;#B;#G=new Map;#z=new Map;#K=!1;#V="[CrossBus]";#X;#W=!1;constructor(e={}){super(),this.#S=e.peerId??s(),this.#x=e.isHub??!1,this.#E=e.meta??{},this.#y=e.capabilities??[],this.#F=e.requestTimeout??3e4,this.#P=new y,this.#H=new R({defaultTimeout:this.#F}),this.#k=new b({peerId:this.#S,meta:this.#E,capabilities:this.#y,timeout:e.handshakeTimeout??1e4}),this.#L=new w({allowed:e.allowedOrigins??[]}),this.#M=e.contentType??"application/json",this.#j=e.maxPayloadSize??1048576,this.#$=e.maxPendingRequests??100,this.#B=e.strictMode??!1,this.#K=e.debug??!1,this.#V=e.debugPrefix??"[CrossBus]",this.#X=Date.now(),this.#Y(e),this.#y.push(`serializer:${this.#M}`),this.#P.on("peer:added",e=>{this.emit("peer:connected",e.data)}),this.#P.on("peer:removed",e=>{this.emit("peer:disconnected",e.data)}),this.#P.on("peer:status",e=>{this.emit("peer:status",e.data)}),this.#K&&this.#Q("info",`Initialized (isHub: ${this.#x})`)}get peerId(){return this.#S}get isHub(){return this.#x}get peerCount(){return this.#P.peerCount}get peers(){return this.#P.getPeerIds()}getPeer(e){return this.#P.getPeer(e)}async signal(t,s,r={}){this.#J();const i=((t,s,r,i=null)=>e(l.SIGNAL,{name:t,data:s,source:r,dest:i}))(t,await this.#Z(this.#U,s,{type:"signal",direction:"outbound"}),this.#S),n=await this.#P.broadcast(i,r);return this.#Q("out",`SIGNAL "${t}" to ${n.delivered} peers`),n}async request(t,s,r,i={}){if(this.#J(),this.#Q("out",`REQUEST "${s}" to ${t}`),!this.#P.getPeer(t))throw E.from(f.PEER_NOT_FOUND,{peerId:t});const{requestId:n,promise:o}=this.#H.create(t,s,{timeout:i.timeout??this.#F}),a=((t,s,r,i,n=null)=>e(l.REQUEST,{name:t,data:s,source:r,dest:i},{},n))(s,await this.#Z(this.#U,r,{type:"request",peerId:t,handlerName:s,direction:"outbound"}),this.#S,t,n);if(!this.#P.route({target:t,payload:a}).success)throw this.#H.cancel(n),E.from(f.SEND_FAILED,{peerId:t});return o}async broadcastRequest(e,t,s={}){this.#J();const r=s.timeout??this.#F,i=s.ignoreErrors??!0,n=new Set(s.exclude??[]),o=new Map,a=[];for(const s of this.#P.getPeerIds()){if(n.has(s))continue;const h=this.request(s,e,t,{timeout:r}).then(e=>{o.set(s,{success:!0,data:e})}).catch(e=>{if(!i)throw e;o.set(s,{success:!1,error:e.message})});a.push(h)}return await Promise.all(a),o}handle(e,t,s={}){if(this.#v.has(e))throw E.from(f.HANDLER_EXISTS,{handlerName:e});return(s.allowedPeers||s.rateLimit||s.validatePayload)&&this.#z.set(e,s),this.#v.set(e,t),()=>{this.#v.delete(e),this.#z.delete(e)}}unhandle(e){return this.#v.delete(e)}hasHandler(e){return this.#v.has(e)}addInboundHook(e,t=10){if("function"!=typeof e)throw new TypeError("hookFn must be a function");return this.#q.push({fn:e,priority:t}),this.#q.sort((e,t)=>e.priority-t.priority),()=>this.removeInboundHook(e)}addOutboundHook(e,t=10){if("function"!=typeof e)throw new TypeError("hookFn must be a function");return this.#U.push({fn:e,priority:t}),this.#U.sort((e,t)=>e.priority-t.priority),()=>this.removeOutboundHook(e)}removeInboundHook(e){const t=this.#q.findIndex(t=>t.fn===e);return-1!==t&&(this.#q.splice(t,1),!0)}removeOutboundHook(e){const t=this.#U.findIndex(t=>t.fn===e);return-1!==t&&(this.#U.splice(t,1),!0)}addPeer(e,t,s={}){this.#J(),this.#P.addPeer(e,t,s)}removePeer(e){return this.#H.cancelForPeer(e),this.#P.removePeer(e)}addTransport(e,t={}){if(this.#J(),!e||"function"!=typeof e.send)throw new TypeError("Transport must have a send() method");const r=t.peerId||e.peerId||`transport-${s()}`,i=t.origin||"*";return"function"==typeof e.onMessage&&e.onMessage(e=>{this.handleMessage(e,i,r)}),this.addPeer(r,t=>{e.send(t)},t),()=>{this.removePeer(r),"function"==typeof e.destroy&&e.destroy()}}async handleMessage(e,t,s,r){if(this.#W)return;if(!this.#L.isAllowed(t))return;const i=e.type??e.t;let n=e.handler??e.name,o=e.payload??e.data??e.p;if(e.payload&&"object"==typeof e.payload&&!e.p)i===l.SIGNAL||i===l.BROADCAST||i===l.REQUEST?(n=e.payload.name,o=e.payload.data):i===l.RESPONSE&&(o=e.payload.data);else if(e.t&&!e.type&&e.p&&"object"==typeof e.p&&e.p.payload){const t=e.p;n=t.payload.name??t.name,o=t.payload.data??t.data}if(void 0!==o){const e={type:i===l.SIGNAL?"signal":i===l.REQUEST?"request":"response",peerId:s,handlerName:n,direction:"inbound"};o=await this.#Z(this.#q,o,e)}switch(i){case l.BROADCAST:case l.SIGNAL:if("string"!=typeof n)return;await this.#ee(n,o,s);break;case l.REQUEST:if("string"!=typeof n)return;await this.#te(e.id,n,o,s,r);break;case l.RESPONSE:{let t=e.success,s=e.error;e.payload&&void 0!==e.payload.success&&(t=e.payload.success,s=e.payload.error),this.#se(e.payload?.requestId??e.id,t,o,s);break}case l.HANDSHAKE_INIT:case l.HANDSHAKE_ACK:case l.HANDSHAKE_COMPLETE:this.#k.handleMessage(e,t,r)}}destroy(){this.#W||(this.#W=!0,this.#H.cancelAll(),this.#v.clear(),this.#P.clearPeers(),this.clear(),this.emit("destroyed",{}))}get isDestroyed(){return this.#W}async#ee(e,t,s){await this.emit(e,{payload:t,source:s})}async#te(e,s,r,i,n){const o=this.#v.get(s);let a;if(o){const n=this.#re(s,i,r);if(n.allowed)try{const n=await o(r,{peerId:i,requestId:e,handlerName:s});a=t(e,await this.#Z(this.#U,n,{type:"response",peerId:i,handlerName:s,direction:"outbound"}),this.#S,!0)}catch(s){a=t(e,null,this.#S,!1,{code:s.code??f.HANDLER_ERROR,message:s.message})}else a=t(e,null,this.#S,!1,{code:n.error?.code??f.UNAUTHORIZED,message:n.error?.message??"Security check failed"})}else a=t(e,null,this.#S,!1,{code:f.NO_HANDLER,message:"Handler not found"});n?n(a):i&&this.#P.route({target:i,payload:a})}#se(e,t,s,r){this.#H.resolve(e,{requestId:e,success:t,data:s,error:r})}#J(){if(this.#W)throw E.from(f.DESTROYED,{context:"CrossBus operation"})}async#Z(e,t,s){let r=t;for(const{fn:t}of e)try{r=await t(r,s)}catch(e){}return r}#Y(e){if(("undefined"!=typeof process?"production"!==process.env?.NODE_ENV:"undefined"!=typeof window&&"localhost"===window.location?.hostname)&&e.allowedOrigins?.includes("*")&&this.#B)throw new Error('strictMode: allowedOrigins: ["*"] is not allowed. Use specific origins for security.')}#re(e,t,s){const r=this.#z.get(e);if(!r)return{allowed:!0};if(r.allowedPeers&&!r.allowedPeers.includes(t))return{allowed:!1,error:E.from(f.UNAUTHORIZED,{handler:e,peer:t,allowedPeers:r.allowedPeers})};if(r.rateLimit&&!this.#ie(`${e}:${t}`,r.rateLimit))return{allowed:!1,error:E.from(f.RATE_LIMITED,{handler:e,peer:t,limit:r.rateLimit})};if(r.validatePayload)try{if(!r.validatePayload(s))return{allowed:!1,error:E.from(f.INVALID_PAYLOAD,{handler:e})}}catch(t){return{allowed:!1,error:E.from(f.INVALID_PAYLOAD,{handler:e,reason:t?.message??"Validation error"})}}return{allowed:!0}}#ie(e,t){const s=Date.now(),r=this.#G.get(e);return!r||s>=r.resetAt?(this.#G.set(e,{count:1,resetAt:s+1e3}),!0):!(r.count>=t||(r.count++,0))}get maxPayloadSize(){return this.#j}get strictMode(){return this.#B}get debug(){return this.#K}get uptime(){return Date.now()-this.#X}#Q(e,t){this.#K}healthCheck(){const e=this.#P.getPeerIds(),t=e.length;let s,r="healthy";if(this.#W?r="unhealthy":0===t&&this.#x&&(r="degraded"),"undefined"!=typeof process&&process.memoryUsage)try{const e=process.memoryUsage();s={heapUsed:e.heapUsed,heapTotal:e.heapTotal,rss:e.rss}}catch{}return{status:r,peerId:this.#S,isHub:this.#x,uptime:this.uptime,peers:{total:t,ids:e},handlers:Array.from(this.#v.keys()),pendingRequests:this.#H.size??0,destroyed:this.#W,...s&&{memory:s}}}static createSecure(e={}){if(!e.allowedOrigins||0===e.allowedOrigins.length)throw new Error('createSecure() requires allowedOrigins to be specified. For development, use: new CrossBus({ allowedOrigins: ["*"] })');if(e.allowedOrigins.includes("*"))throw new Error('createSecure() does not allow wildcard origins. Specify exact origins: allowedOrigins: ["https://example.com"]');return new N({strictMode:!0,maxPayloadSize:1048576,maxPendingRequests:100,requestTimeout:3e4,...e})}diagnose(){const e=[],t=[],s=[];if(this.#W)return e.push("Instance is destroyed"),t.push("Create a new CrossBus instance"),{status:"error",issues:e,suggestions:t,warnings:s};const r=this.#P.getPeerIds().length;0===r&&(this.#x?(s.push("Hub has no connected peers"),t.push("Add transports with addTransport() or wait for agents to connect")):(e.push("Agent has no connected peers"),t.push('Add a transport to connect to hub: bus.addTransport(transport, {peerId: "hub"})')));const i=this.#v.size;this.#x&&0===i&&(s.push("Hub has no registered handlers"),t.push('Register handlers with bus.handle("name", fn)'));const n=this.#H.size??0;n>.8*this.#$&&(s.push(`High pending request count: ${n}/${this.#$}`),t.push("Consider increasing maxPendingRequests or check for slow handlers")),this.#B||(s.push("strictMode is disabled"),t.push("For production, use CrossBus.createSecure() or set strictMode: true"));let o="healthy";return e.length>0?o="error":s.length>0&&(o="warning"),{status:o,peerId:this.#S,isHub:this.#x,peerCount:r,handlerCount:i,pendingRequests:n,uptime:this.uptime,issues:e,warnings:s,suggestions:t}}}export{N as CrossBus};
//# sourceMappingURL=crossbus.core.min.js.map
